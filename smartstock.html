<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartPlant</title>
  <link rel="icon" type="icon" href="images/logo.png" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    * {box-sizing:border-box;}
    body {
      margin: 0;
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color:#111;
      color:#eee;
      font-size:16px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body.dark-theme { background-color:#111; color:#eee; }
    body:not(.dark-theme) { background-color: #f5f5f5; color: #222; }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;}
    header {display:flex; align-items:center; justify-content:space-between;border-bottom:2px solid #444;padding:10px 24px;margin-bottom:20px;color:#eee;}
    body:not(.dark-theme) header { color:#004d40; border-bottom-color:#9ccc65; }
    .main-logo{ width:48px; height:48px; object-fit:contain; margin-right:12px;}
    header .header-left { display:flex; align-items:center; }
    header h2.pageTitle { flex-grow:1; font-weight:600; font-size:1.8rem; color:#26a69a; margin:0; }
    body:not(.dark-theme) header h2.pageTitle { color:#2e7d32; }
    .header-right { display:flex; align-items:center; }

    .theme-switch { position:relative; display:inline-block; width:60px; height:30px; cursor:pointer; user-select:none; }
    .theme-switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; top:0; left:0; right:0; bottom:0; background-color:#444; border-radius:34px; transition: background-color 0.3s ease; }
    body:not(.dark-theme) .slider { background-color:#ddd; }
    .slider:before { position:absolute; content:""; height:26px; width:26px; left:2px; bottom:2px; background-color:#26a69a; border-radius:50%; transition: transform 0.3s ease; }
    body:not(.dark-theme) .slider:before { background-color:#4caf50; }
    .theme-switch input:checked + .slider { background-color:#222; }
    body:not(.dark-theme) .theme-switch input:checked + .slider { background-color:#4caf50; }
    .theme-switch input:checked + .slider:before { transform: translateX(30px); }
    .slider .sun-icon, .slider .moon-icon { position:absolute; top:50%; transform:translateY(-50%); pointer-events:none; font-size:16px; }
    .slider .moon-icon { right:6px; color:#ecf0f1; }
    body:not(.dark-theme) .slider .moon-icon { color:#555; }
    .slider .sun-icon { left:6px; color:#f1c40f; }
    body:not(.dark-theme) .slider .sun-icon { color:#fbc02d; }

    .loader-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(20,40,60,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .loader { border:6px solid #555; border-top:6px solid #26a69a; border-radius:50%; width:48px; height:48px; animation:spin 0.8s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg);}}

    .notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2a2a2a; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 10000; text-align: center; color: #eee; }
    body:not(.dark-theme) .notification { background: #fff; color: #222; }
    .notification p { margin: 0 0 15px; }
    .notification button { padding: 10px 20px; background: #26a69a; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    body:not(.dark-theme) .notification button { background: #4caf50; }

    .page { display:none; padding:24px; margin:48px auto 90px; background-color:#1e1e1e; border-radius:12px; box-shadow:0 10px 30px rgba(38,166,154,0.3); color:#eee; }
    body:not(.dark-theme) .page { background-color:#fefefe; color:#222; }
    .page.active{display:block;}

    .alert-section { background:#4a1a1a; border:1.5px solid #ff4d4d; color:#ff8585; padding:16px 20px; border-radius:10px; display:flex; align-items:center; margin-bottom:20px; user-select:none; }
    body:not(.dark-theme) .alert-section { background:#ffcdd2; border-color:#b71c1c; color:#b71c1c; }
    .alert-icon { font-size:28px; margin-right:16px; color:#ff4d4d; }
    body:not(.dark-theme) .alert-icon { color:#b71c1c; }
    .alert-content h3 { margin:0 0 6px; font-weight:700; }
    .alert-content ul { margin:0; padding-left:20px; }

    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:24px; margin-bottom:24px; }
    .stat-card { background:linear-gradient(135deg,#324a4a 0%,#264a4a 100%); border-radius:14px; padding:24px 20px; box-shadow:0 6px 24px rgba(38,166,154,0.4); color:#b0f0ee; text-align:center; font-weight:600; }
    body:not(.dark-theme) .stat-card { background:#c8e6c9; color:#2e7d32; box-shadow:none; }
    .stat-card h3 { margin:12px 0 0; font-size:2rem; font-weight:700; color:#26a69a; text-shadow:none; }

    .graph { background-color:#264a4a; padding:28px; border-radius:16px; box-shadow:0 8px 24px rgba(38,166,154,0.3); margin-bottom:32px; }
    body:not(.dark-theme) .graph { background:#e8f5e9; box-shadow:none; }

    /* Grid wrapper to display graphs two-per-row on larger screens */
    .graphs-wrapper { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; align-items: start; }
    @media (max-width: 900px) { .graphs-wrapper { grid-template-columns: 1fr; } }

    /* Ensure status colors remain correct in light theme (override general span color) */
    body:not(.dark-theme) .status-off { color: #f44336 !important; }
    body:not(.dark-theme) .status-on { color: #4caf50 !important; }

    .schedule-summary { background-color:#264a4a; padding:20px; border-radius:16px; margin-bottom:32px; }
    body:not(.dark-theme) .schedule-summary { background:#e8f5e9; }
    .schedule-summary h3 { margin:0 0 12px; color:#26a69a; }
    .schedule-summary ul { list-style:none; padding:0; margin:0; }
    .schedule-summary li { padding:8px 0; border-bottom:1px solid #444; }
    body:not(.dark-theme) .schedule-summary li { border-bottom-color:#ccc; }

    .actions { display:flex; gap:16px; margin-bottom:48px; }
    .actions button { flex:1; padding:16px; font-weight:700; background:linear-gradient(90deg,#26a69a 70%,#22a59a 100%); color:#fff; border:none; border-radius:12px; cursor:pointer; box-shadow:0 4px 14px rgba(38,166,154,0.7); transition:background 0.3s,box-shadow 0.2s; }
    body:not(.dark-theme) .actions button { background:linear-gradient(90deg, #4caf50 70%, #388e3c 100%); box-shadow:none; color:#fff; }
    .actions button:hover, .actions button:focus { background:linear-gradient(90deg,#154b48 80%,#1c6b6a 100%); box-shadow:0 6px 20px rgba(20,100,96,0.8); outline:none; }

    .machine-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
    .machine-card { background-color:#1e4d4d; border-radius:14px; padding:20px; box-shadow:0 8px 28px rgba(38,166,154,0.5); transition: box-shadow 0.25s, transform 0.25s; color:#c5e1e1; position: relative; }
    body:not(.dark-theme) .machine-card { background:#aed581; color:#33691e; box-shadow:none; }
    .machine-card:hover, .machine-card:focus-within { box-shadow:0 14px 42px rgba(38,166,154,0.8); transform:translateY(-6px); outline:none; }
    .machine-card img.machine-img { width:100%; height:140px; border-radius:12px; object-fit:cover; margin-bottom:12px; }
    .machine-card h3 { margin-top:0; font-size:1.5rem; font-weight:700; color:#5ad1cd; }
    body:not(.dark-theme) .machine-card h3 { color:#33691e; }
    .machine-card p { margin:8px 0 0; font-weight:600; }
    .machine-card p span { color:#b0f0ee; }
    body:not(.dark-theme) .machine-card p span { color:#558b2f; }
    .machine-card p span.red-highlight { color:#ff4444; font-weight:800; }
    /* Force chemical mixer temp to red regardless of theme */
    .machine-card.chemical-mixer p span.chemical-temp { color: #f44336 !important; font-weight:900; }

    /* Admin badge and audible alert styles */
    .admin-badge { position: absolute; top: -6px; right: -8px; background: #d32f2f; color: #fff; border-radius: 12px; padding: 2px 6px; font-size: 0.75rem; font-weight:700; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
    .admin-badge[data-count="0"] { display: none; }
    .machine-card button { margin:10px 8px 0 0; padding:10px 20px; border:none; border-radius:10px; background:linear-gradient(90deg,#26a69a 70%,#22a59a 100%); color:#fff; font-weight:600; cursor:pointer; transition:background 0.3s; }
    .machine-card button:hover, .machine-card button:focus { background:linear-gradient(90deg,#154b48 80%,#1c6b6a 100%); outline:none; }
    body:not(.dark-theme) .machine-card button { background:linear-gradient(90deg, #4caf50 70%, #388e3c 100%); }
    .machine-status { display: none; position: absolute; top: 10px; right: 10px; font-size: 1.2rem; }
    .status-on { color: #4caf50; }
    .status-off { color: #f44336; }

    /* Admin Requests / Alerts page headers */
    #adminRequestsPage h3 { font-size: 1.2rem; font-weight: 800; color: #ffd54f; margin: 8px 0 10px; }
    body:not(.dark-theme) #adminRequestsPage h3 { color: #ff8f00; }
    #adminRequestsPage h4 { font-size: 1rem; font-weight: 700; color: #fff3cd; margin: 10px 0; }
    body:not(.dark-theme) #adminRequestsPage h4 { color: #795548; }
    .profile-container { max-width: 600px; margin: 0 auto; }
    .profile-card { background-color: #264a4a; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(38,166,154,0.3); }
    body:not(.dark-theme) .profile-card { background: #e8f5e9; }
    .profile-header { text-align: center; margin-bottom: 20px; }
    .profile-pic-container { position: relative; display: inline-block; margin-bottom: 12px; }
    .profile-pic { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid #26a69a; box-shadow: 0 6px 25px rgba(38,166,154,0.8); transition: box-shadow 0.3s; }
    body:not(.dark-theme) .profile-pic { border-color: #4caf50; }
    .profile-pic:hover, .profile-pic:focus { box-shadow: 0 10px 40px rgba(38,166,154,1); outline: none; }
    .upload-pic-label { position: absolute; bottom: 8px; right: 8px; background: #00796b; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 10px rgba(0,121,107,0.7); transition: background 0.3s; }
    .upload-pic-label:hover, .upload-pic-label:focus { background: #004d40; outline: none; }

    .profile-container h3 { margin: 0 0 8px; font-weight: 700; font-size: 1.8rem; color: #26a69a; }
    body:not(.dark-theme) .profile-container h3 { color: #2e7d32; }
    .profile-container p { margin: 0 0 4px; font-weight: 600; color: #96ded1; }
    body:not(.dark-theme) .profile-container p { color: #558b2f; }
    .profile-info p { display: flex; align-items: center; margin: 12px 0; font-size: 1.1rem; }
    .profile-info i { margin-right: 12px; color: #26a69a; font-size: 1.3rem; }
    body:not(.dark-theme) .profile-info i { color: #4caf50; }

    .activity-log { background-color: #264a4a; padding: 20px; border-radius: 16px; margin-bottom: 24px; }
    body:not(.dark-theme) .activity-log { background: #e8f5e9; }
    .activity-log h3 { margin: 0 0 12px; color: #26a69a; }
    body:not(.dark-theme) .activity-log h3 { color: #2e7d32; }
    .activity-log ul { list-style: none; padding: 0; margin: 0; }
    .activity-log li { padding: 8px 0; border-bottom: 1px solid #444; }
    body:not(.dark-theme) .activity-log li { border-bottom-color: #ccc; }

    .profile-actions { display: flex; gap: 16px; }
    .profile-actions button { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.3s; box-shadow: 0 4px 14px rgba(38,166,154,0.7); }
    .profile-actions button:first-child { background: linear-gradient(90deg, #26a69a 70%, #22a59a 100%); color: #fff; }
    .profile-actions button:first-child:hover { background: linear-gradient(90deg, #154b48 80%, #1c6b6a 100%); }
    .profile-actions button:last-child { background: #ff5555; color: #fff; box-shadow: 0 6px 18px rgba(220,80,80,0.7); }
    .profile-actions button:last-child:hover { background: #cc4444; }
    body:not(.dark-theme) .profile-actions button:first-child { background: linear-gradient(90deg, #4caf50 70%, #388e3c 100%); box-shadow:none; }
    body:not(.dark-theme) .profile-actions button:first-child:hover { background: linear-gradient(90deg, #2e7d32 80%, #1b5e20 100%); }
    body:not(.dark-theme) .profile-actions button:last-child { background: #e53935; box-shadow:none; }
    body:not(.dark-theme) .profile-actions button:last-child:hover { background: #b71c1c; }

    #profileSettingsForm { display:flex; flex-direction:column; gap:16px; margin-top:12px; }
    #profileSettingsForm label { font-weight:600; color:#26a69a; }
    body:not(.dark-theme) #profileSettingsForm label { color:#2e7d32; }
    #profileSettingsForm input, #profileSettingsForm select { padding:10px 14px; font-size:1rem; border-radius:8px; border:1.8px solid #555; background-color:#1e1e1e; color:#eee; transition:border-color 0.3s; }
    body:not(.dark-theme) #profileSettingsForm input, body:not(.dark-theme) #profileSettingsForm select { background-color:#f0f4c3; color:#33691e; border-color:#9e9d24; }
    #profileSettingsForm input:focus, #profileSettingsForm select:focus { border-color:#4ff0de; outline:none; box-shadow:0 0 10px #26a69abb; }
    #profileSettingsForm button { padding:14px 0; font-weight:700; background:linear-gradient(90deg,#26a69a 70%,#22a59a 100%); color:white; border:none; border-radius:12px; cursor:pointer; box-shadow:0 6px 20px rgba(38,166,154,0.9); transition:background 0.3s, box-shadow 0.2s; }

    .schedule-form { max-width:420px; margin:0 auto 40px; padding:28px 32px; border-radius:16px; background:#1e4d4d; box-shadow:0 14px 40px rgba(38,166,154,0.4); transition:background 0.3s, color 0.3s; color:#cdf3f0; }
    body:not(.dark-theme) .schedule-form { background:#dcedc8; color:#33691e; box-shadow:none; }
    .schedule-form label { display:block; margin-top:16px; margin-bottom:6px; font-weight:600; }
    .schedule-form input { width:100%; padding:14px 18px; border-radius:10px; border:1.8px solid #4ca8a0; font-size:1rem; transition:border-color 0.3s; background-color:#295f5a; color:#d1f2ee; }
    body:not(.dark-theme) .schedule-form input { background-color:#f0f4c3; color:#33691e; border-color:#9e9d24; }
    .schedule-form input:focus { border-color:#4ff0de; outline:none; box-shadow:0 0 10px #4ff0de66; }
    .schedule-form button { margin-top:28px; width:100%; padding:16px; border:none; border-radius:12px; background:linear-gradient(90deg,#26a69a 70%,#22a59a 100%); color:white; font-weight:700; font-size:1.2rem; cursor:pointer; box-shadow:0 6px 20px rgba(38,166,154,0.9); transition:background 0.3s, box-shadow 0.2s; }

    .bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#1b3b3a; border-top:2px solid #144a49; display:flex; justify-content:space-around; padding:14px 0; box-shadow:0 -2px 20px rgba(38,166,154,0.6); z-index:999; }
    body:not(.dark-theme) .bottom-nav { background:#aed581; border-top-color:#689f38; box-shadow:none; }
    .bottom-nav a { position:relative; font-size:1.8rem; cursor:pointer; color:#4fd5c8; transition:color 0.3s; padding:6px 12px; }
    body:not(.dark-theme) .bottom-nav a { color:#33691e; }
    .bottom-nav a:hover, .bottom-nav a:focus { color:#a6eadc; outline:none; }
    body:not(.dark-theme) .bottom-nav a:hover, body:not(.dark-theme) .bottom-nav a:focus { color:#558b2f; }
    .bottom-nav a.active::before { content:""; position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:70%; height:14px; background:#26a69a; opacity:0.35; border-radius:50% 50% 0 0; pointer-events:none; transition:opacity 0.3s; }
    body:not(.dark-theme) .bottom-nav a.active::before { background:#689f38; }

    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(20,40,60,0.5); display:none; align-items:center; justify-content:center; z-index:10500; }
    .modal[aria-hidden="false"] { display:flex; }
    .modal-content { background:#fff; border-radius:14px; padding:20px 30px; width:90%; max-width:800px; max-height: 90vh; overflow-y: auto; box-shadow:0 10px 30px rgba(0,0,0,0.25); position:relative; font-size:1rem; color:#222; }
    body.dark-theme .modal-content { background:#2a2a2a; color:#eee; }
    .modal-back-btn { position:sticky; top:0; left:12px; background:transparent; border:none; font-size:1.4rem; cursor:pointer; color:#999; transition:color 0.3s; z-index: 1; }
    .modal-back-btn:hover, .modal-back-btn:focus { color:#555; outline:none; }
    body.dark-theme .modal-back-btn { color:#ccc; }
    body.dark-theme .modal-back-btn:hover, body.dark-theme .modal-back-btn:focus { color:#fff; }

    .role-slider{ position:relative; display:flex; width:250px; height:44px; background:#264a4a; border-radius:30px; padding:2px; margin:20px auto; box-shadow:inset 0 0 10px rgba(0,0,0,0.3); }
    body:not(.dark-theme) .role-slider{ background:#c8e6c9; box-shadow:inset 0 0 10px rgba(0,0,0,0.1); }
    .role-slider input[type="radio"]{ display:none; }
    .role-slider label.slider-label{ width:50%; text-align:center; padding:12px 0; border-radius:30px; cursor:pointer; z-index:2; font-weight:700; background:#264a4a; color:#b0f0ee; transition:all .25s; margin:0; }
    body:not(.dark-theme) .role-slider label.slider-label{ background:#c8e6c9; color:#33691e; }
    .role-slider .slider{ position:absolute; top:0; left:0; width:100%; height:44px; background:transparent; border-radius:30px; z-index:1; transition:left .3s ease; }
    @media (max-width:480px){ .role-slider{ width:200px; } }
    /* registration UI removed; login only */
    #otpModal .modal-content input { width: 100%; padding: 12px; margin: 12px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1.2rem; text-align: center; letter-spacing: 12px; }
    body.dark-theme #otpModal .modal-content input { background: #1e1e1e; border-color: #555; color: #eee; }
    #otpModal .modal-content button { width: 100%; margin-top: 10px; padding: 12px; border: none; border-radius: 8px; background: #26a69a; color: white; font-weight: 700; cursor: pointer; transition: background 0.3s; }
    body:not(.dark-theme) #otpModal .modal-content button { background: #4caf50; }
    #otpModal .modal-content button:hover { background: #1e847f; }
    body:not(.dark-theme) #otpModal .modal-content button:hover { background: #388e3c; }
    #otpModal .modal-content #resendOtpBtn { background: #607d8b; margin-top: 5px; }
    #otpModal .modal-content #resendOtpBtn:hover { background: #455a64; }

    .repair-page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 2px solid #333; }
    body:not(.dark-theme) .repair-page-header { border-bottom-color: #ddd; }
    .repair-page-header h2 { margin: 0; color: #26a69a; }
    body:not(.dark-theme) .repair-page-header h2 { color: #2e7d32; }
    #adminApprovalBtnHeader { padding: 10px 18px; background: linear-gradient(90deg, #b04e4e 70%, #9a4242 100%); color: #fff; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 14px rgba(220,80,80,0.7); transition: background 0.3s, box-shadow 0.2s; }
    #adminApprovalBtnHeader:hover { background: linear-gradient(90deg, #9a4242 80%, #7d3535 100%); box-shadow: 0 6px 20px rgba(220,80,80,1); }
    body:not(.dark-theme) #adminApprovalBtnHeader { background: #e53935; box-shadow: none; }
    body:not(.dark-theme) #adminApprovalBtnHeader:hover { background: #c62828; }

    .repair-select { width: 100%; padding: 12px 18px; border-radius: 10px; border: 1.8px solid #4ca8a0; font-size: 1.1rem; background-color: #295f5a; color: #d1f2ee; margin-bottom: 24px; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23d1f2ee"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat: no-repeat; background-position: right 18px center; cursor: pointer; }
    body:not(.dark-theme) .repair-select { background-color: #f0f4c3; color: #33691e; border-color: #9e9d24; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%2333691e"><path d="M7 10l5 5 5-5z"/></svg>'); }
    .repair-select:focus { border-color: #4ff0de; outline: none; box-shadow: 0 0 10px #4ff0de66; }

    .spares-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .spare-card { background-color: #1e4d4d; border-radius: 14px; padding: 16px; box-shadow: 0 8px 28px rgba(38,166,154,0.5); transition: box-shadow 0.25s, transform 0.25s; color: #c5e1e1; display: flex; flex-direction: column; }
    body:not(.dark-theme) .spare-card { background: #aed581; color: #33691e; box-shadow: none; }
    .spare-card:hover { box-shadow: 0 14px 42px rgba(38,166,154,0.8); transform: translateY(-4px); }
    .spare-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
    .spare-card h4 { margin: 0 0 4px; font-size: 1.2rem; color: #5ad1cd; }
    body:not(.dark-theme) .spare-card h4 { color: #33691e; }
    .spare-card p { margin: 0 0 10px; font-size: 0.9rem; color: #96ded1; }
    body:not(.dark-theme) .spare-card p { color: #558b2f; }
    .spare-actions { display: flex; align-items: center; gap: 10px; margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
    body:not(.dark-theme) .spare-actions { border-top-color: rgba(0,0,0,0.1); }
    .spare-actions input[type="number"] { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #4ca8a0; background-color: #1b3b3a; color: #d1f2ee; text-align: center; font-size: 1rem; }
    body:not(.dark-theme) .spare-actions input[type="number"] { background-color: #f0f4c3; color: #33691e; border-color: #9e9d24; }
    .spare-actions button.request-btn { flex-grow: 1; padding: 10px; border: none; border-radius: 8px; background: linear-gradient(90deg, #26a69a 70%, #22a59a 100%); color: #fff; font-weight: 600; cursor: pointer; transition: background 0.3s; box-shadow: 0 2px 8px rgba(38,166,154,0.7); }
    .spare-actions button.request-btn:hover { background: linear-gradient(90deg, #154b48 80%, #1c6b6a 100%); }
    body:not(.dark-theme) .spare-actions button.request-btn { background: linear-gradient(90deg, #4caf50 70%, #388e3c 100%); box-shadow: none; }
    body:not(.dark-theme) .spare-actions button.request-btn:hover { background: linear-gradient(90deg, #2e7d32 80%, #1b5e20 100%); }

    #assistanceModalForm textarea { width: 100%; min-height: 120px; padding: 12px; border-radius: 8px; border: 1.8px solid #555; background-color: #1e1e1e; color: #eee; resize: vertical; font-family: inherit; font-size: 1rem; margin-bottom: 16px; }
    body:not(.dark-theme) #assistanceModalForm textarea { background-color: #f0f4c3; color: #33691e; border-color: #9e9d24; }

    #approvalListContainer { margin-top: 16px; max-height: 70vh; overflow-y: auto; }
    .request-item { background-color: #1b3b3a; border-radius: 10px; padding: 14px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border-left: 5px solid #26a69a; }
    body:not(.dark-theme) .request-item { background-color: #e8f5e9; border-left-color: #4caf50; }
    .request-item p { margin: 0; font-size: 1rem; }
    .request-item .status-pending { color: #ff9800; font-weight: 700; }
    .request-item .status-approved { color: #4caf50; font-weight: 700; }
    .request-item .status-rejected { color: #f44336; font-weight: 700; }
    .approval-actions { display: flex; gap: 10px; margin-top: 10px; }
    .approval-actions button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .approval-actions button.approve { background: #4caf50; color: white; }
    .approval-actions button.approve:hover { background: #388e3c; }
    .approval-actions button.reject { background: #f44336; color: white; }
    .approval-actions button.reject:hover { background: #d32f2f; }

    .fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(90deg,#26a69a 70%,#22a59a 100%); color: #fff; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .fab:hover { background: linear-gradient(90deg,#154b48 80%,#1c6b6a 100%); }
    body:not(.dark-theme) .fab { background: linear-gradient(90deg, #4caf50 70%, #388e3c 100%); }
    body:not(.dark-theme) .fab:hover { background: linear-gradient(90deg, #2e7d32 80%, #1b5e20 100%); }
  </style>
</head>
<body>
  <div id="loader" class="loader-overlay" style="display:none;">
    <div class="loader" role="status" aria-label="Loading..."></div>
  </div>

  <div id="notification" class="notification" role="alert" aria-live="assertive" style="display:none;">
    <p id="notificationMessage">Notification Text</p>
    <button onclick="document.getElementById('notification').style.display='none'">OK</button>
  </div>

  <!-- LOGIN PAGE -->
  <main id="loginPage" class="page active" aria-label="Login Page">
    <header>
      <div class="header-left">
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle">Smart Plant Login</h2>
      <div class="header-right">
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <section class="schedule-form" role="form" aria-labelledby="loginHeading">
      <h3 id="loginHeading" class="sr-only">Login</h3>
      <form id="loginForm">
        <div style="text-align:center; margin:10px 0 18px; font-weight:700; color:#26a69a;">Login</div>
        <label for="userId">User ID</label>
        <input type="text" id="userId" placeholder="Enter your User ID" required aria-required="true" />
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password" required aria-required="true" />

        <!-- role selector removed: authentication uses predefined credentials -->

        <button type="submit" aria-label="Login" style="display:block;margin:10px auto 0;min-width:160px;padding:10px 18px;font-weight:700;">Login</button>
      </form>
    </section>
  </main>

  <!-- DASHBOARD -->
  <main id="dashboardPage" class="page" aria-label="Dashboard">
    <header>
      <div class="header-left">
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>
      <div class="header-right">
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider2" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <section id="alertSection" class="alert-section" aria-live="polite" aria-atomic="true" style="display:none;">
      <i class="fa-solid fa-triangle-exclamation alert-icon"></i>
      <div class="alert-content">
        <h3>Alerts</h3>
        <ul id="alertList"></ul>
      </div>
    </section>
    <section class="stats" aria-live="polite" aria-atomic="true">
      <div class="stat-card" tabindex="0">
        Current Load
        <h3 id="plantLoad">92.7 kW</h3>
      </div>
      <div class="stat-card" tabindex="0">
        Running Cost
        <h3 id="runningCost">₹1390/hr</h3>
      </div>
      <div class="stat-card" tabindex="0">
        Monthly Estimate
        <h3 id="monthlyBill">₹1001K</h3>
      </div>
      <div class="stat-card" tabindex="0">
        Active Machines
        <h3 id="activeMachines">5/8</h3>
      </div>
      <div class="stat-card" tabindex="0">
        Total Energy Today
        <h3 id="totalEnergy">456 kWh</h3>
      </div>
    </section>
    <div class="graphs-wrapper">
    <section class="graph" aria-label="Energy consumption chart">
      <canvas id="energyChart" role="img" aria-describedby="energyChartDesc"></canvas>
      <p id="energyChartDesc" class="sr-only">Line chart showing power consumption over the last 12 hours.</p>
    </section>
    <section class="graph" aria-label="Temperature chart">
      <canvas id="tempChart" role="img" aria-describedby="tempChartDesc"></canvas>
      <p id="tempChartDesc" class="sr-only">Line chart showing temperature levels over the last 12 hours.</p>
    </section>
    <section class="graph" id="monthlyGraph" style="display:none;" aria-label="Monthly energy chart">
      <h3>Monthly Energy Consumption (Last 12 Months)</h3>
      <canvas id="monthlyChart" role="img" aria-describedby="monthlyChartDesc"></canvas>
      <p id="monthlyChartDesc" class="sr-only">Bar chart showing energy consumption over the last 12 months.</p>
    </section>
    </div>
    <section class="activity-log admin-logs" id="adminLogsSection" style="display:none;">
      <h3>All User Activity Logs (Last 30 Days)</h3>
      <ul id="allActivityLogs"></ul>
    </section>
    <section class="schedule-summary" aria-label="Upcoming Scheduled Tasks">
      <h3>Upcoming Tasks</h3>
      <ul id="upcomingTasksList"></ul>
    </section>
    <section class="actions" role="navigation" aria-label="Dashboard actions">
      <button onclick="navigateTo('machinesPage')" aria-label="View All Machines">View All Machines</button>
      <button onclick="navigateTo('schedulePage')" aria-label="Schedule Tasks">Schedule Tasks</button>
      <button onclick="exportReport()" aria-label="Export Data Report">Export Report</button>
    </section>
  </main>

  <!-- MACHINES PAGE -->
  <main id="machinesPage" class="page" aria-label="Machines List">
    <header>
      <div class="header-left">
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle"><i class="fa-solid fa-industry"></i> Machines</h2>
      <div class="header-right">
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider3" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <section class="machine-list" id="machineList" aria-live="polite"></section>
  </main>

  <!-- PROFILE PAGE -->
  <main id="profilePage" class="page" aria-label="User Profile">
    <header>
      <div class="header-left">
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle"><i class="fa-solid fa-user"></i> Profile</h2>
      <div class="header-right">
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider6" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <div class="profile-container">
      <div class="profile-card profile-header">
        <div class="profile-pic-container">
          <img src="images/profile.jpg" alt="User Profile Picture" id="profilePic" class="profile-pic" />
          <label for="uploadPic" class="upload-pic-label" aria-label="Change profile picture">
            <i class="fa-solid fa-camera"></i>
          </label>
        </div>
        <h3 id="profileName">Admin User</h3>
        <p id="profileRole">Role: Admin</p>
      </div>

      <div class="profile-card profile-info">
        <h3>User Information</h3>
        <p><i class="fa-solid fa-envelope"></i> <span id="profileEmail">admin@smartplant.com</span></p>
        <p><i class="fa-solid fa-calendar-days"></i> <span id="profileLastLogin">Last Login: September 14, 2025</span></p>
        <p><i class="fa-solid fa-earth-americas"></i> Language: English</p>
      </div>

      <div class="profile-card activity-log">
        <h3>Activity Log</h3>
        <ul id="activityLogList"></ul>
      </div>

      <div class="profile-actions">
        <button id="openProfileSettingsBtn" aria-label="Open Profile Settings">Settings</button>
        <button onclick="logout()" aria-label="Logout">Logout</button>
      </div>
    </div>
  </main>

  <!-- SCHEDULE PAGE -->
  <main id="schedulePage" class="page" aria-label="Schedule a Task">
    <header>
      <div class="header-left">
        <span tabindex="0" role="button" class="schedule-page-back" id="scheduleBackBtn" aria-label="Back to Dashboard">
          <i class="fa-solid fa-arrow-left"></i>
        </span>
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle">Schedule Machinery Task</h2>
      <div class="header-right">
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider4" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <section class="schedule-form" role="form" aria-labelledby="scheduleHeading" aria-live="polite" aria-atomic="true" >
      <label for="scheduleMachineSelect">Select Machine</label>
      <select id="scheduleMachineSelect" style="width:100%;padding:12px;border-radius:8px;border:1.5px solid #4ca8a0;background-color:#295f5a;color:#d1f2ee;">
        <option value="">-- Select a Machine --</option>
      </select>
      <label for="machineName">Machine Name</label>
      <input type="text" id="machineName" placeholder="Machine Name" readonly />
      <label for="taskName">Task Name</label>
      <input type="text" id="taskName" placeholder="Enter Task Name" required aria-required="true" />
      <label for="taskTime">Time</label>
      <input type="time" id="taskTime" required aria-required="true" />
      <button id="saveTask" aria-label="Save Task">Save Task</button>
    </section>
  </main>

  <!-- REPAIR PAGE -->
  <main id="repairPage" class="page" aria-label="Repair and Spare Parts">
    <header>
      <div class="header-left">
        <span tabindex="0" role="button" class="schedule-page-back" onclick="navigateTo('dashboardPage')" aria-label="Back to Dashboard">
          <i class="fa-solid fa-arrow-left"></i>
        </span>
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle"><i class="fa-solid fa-screwdriver-wrench"></i> Repair & Spare Parts</h2>
      <div class="header-right">
        <button id="adminApprovalBtnHeader" onclick="navigateTo('adminRequestsPage')" aria-label="View Pending Spare Part Requests" style="display:none;position:relative;">
          <i class="fa-solid fa-list-check"></i> Pending Requests (Admin)
          <span id="adminBadge" class="admin-badge" aria-hidden="true" style="display:none;">0</span>
        </button>
        <label class="theme-switch" aria-label="Toggle theme" tabindex="0">
          <input type="checkbox" id="themeToggleSlider5" />
          <span class="slider round">
            <i class="fa-solid fa-sun sun-icon"></i>
            <i class="fa-solid fa-moon moon-icon"></i>
          </span>
        </label>
      </div>
    </header>
    <section aria-labelledby="machineSelectionHeading">
      <h3 id="machineSelectionHeading" class="sr-only">Machine Selector</h3>
      <select id="machineSelect" class="repair-select" onchange="populateSpareParts()" aria-label="Select Machine for Spare Parts">
        <option value="">-- Select a Machine --</option>
      </select>
    </section>

    <section aria-labelledby="sparePartsHeading">
      <h3 id="sparePartsHeading">Spare Parts Catalog</h3>
      <div id="sparesGrid" class="spares-grid" aria-live="polite">
        <p id="partsPlaceholder" style="text-align:center; color:#96ded1;">Select a machine to view available spare parts.</p>
      </div>
    </section>
  </main>

  <!-- ADMIN REQUESTS PAGE -->
  <main id="adminRequestsPage" class="page" aria-label="Admin Requests">
    <header>
      <div class="header-left">
        <span tabindex="0" role="button" class="schedule-page-back" onclick="navigateTo('dashboardPage')" aria-label="Back to Dashboard">
          <i class="fa-solid fa-arrow-left"></i>
        </span>
        <img src="images/logo.png" alt="SmartPlant Logo" class="main-logo" />
      </div>
      <h2 class="pageTitle"><i class="fa-solid fa-bell"></i> Admin Requests</h2>
      <div class="header-right">
        <div style="display:flex;gap:8px;align-items:center;">
          <button onclick="exportAdminRequestsCSV()" aria-label="Export CSV" style="padding:8px 12px;border-radius:8px;">CSV</button>
          <button onclick="exportAdminRequestsXLSX()" aria-label="Export XLSX" style="padding:8px 12px;border-radius:8px;">XLSX</button>
          <button onclick="exportAdminRequestsPDF()" aria-label="Export PDF" style="padding:8px 12px;border-radius:8px;">PDF</button>
          <div style="width:12px"></div>
          <button onclick="exportAdminAllCSV()" aria-label="Export All CSV" style="padding:8px 12px;border-radius:8px;background:#1976d2;color:#fff;">All CSV</button>
          <button onclick="exportAdminAllXLSX()" aria-label="Export All XLSX" style="padding:8px 12px;border-radius:8px;background:#1976d2;color:#fff;">All XLSX</button>
          <button onclick="exportAdminAllPDF()" aria-label="Export All PDF" style="padding:8px 12px;border-radius:8px;background:#1976d2;color:#fff;">All PDF</button>
        </div>
      </div>
    </header>
    <section style="padding:20px;">
      <h3>Spare Part Requests</h3>
      <div id="adminSparesContainer" style="margin-bottom:20px;"></div>
      <h3>Assistance Requests</h3>
      <div id="adminAssistanceContainer"></div>
      <h3>Machine History</h3>
        <div id="adminMachinesContainer" style="margin-bottom:20px;"></div>
        <p id="adminMachinesHistorySummary" style="color:#6b6b6b;margin-top:6px;font-size:0.95rem;"></p>
      <h3>Scheduled Tasks</h3>
      <div id="adminScheduledContainer" style="margin-bottom:20px;"></div>
      <h3>Activity Logs</h3>
      <ul id="adminActivityLogs"></ul>
      <h3>Alerts History</h3>
      <div id="adminAlertsHistory" style="margin-bottom:12px;"></div>
      <h3>Spare Parts Inventory</h3>
      <div id="adminSpareInventory" style="margin-bottom:12px;"></div>
      <h3>Energy Summary</h3>
      <div id="adminEnergySummary" style="margin-bottom:12px;"></div>
    </section>
  </main>

  <!-- NAV -->
  <nav class="bottom-nav" id="bottomNav" aria-label="Primary Navigation">
    <a href="#" onclick="navigateTo('dashboardPage');return false" aria-label="Home Dashboard" tabindex="0"><i class="fa-solid fa-house"></i></a>
    <a href="#" onclick="navigateTo('machinesPage');return false" aria-label="Machines Page" tabindex="0"><i class="fa-solid fa-industry"></i></a>
    <a href="#" onclick="navigateTo('schedulePage');return false" aria-label="Schedule Tasks" tabindex="0"><i class="fa-solid fa-calendar"></i></a>
    <a id="repairNavLink" href="#" onclick="navigateTo('repairPage');return false" aria-label="Repair & Spare Parts" tabindex="0" style="display:none;">
      <i class="fa-solid fa-screwdriver-wrench"></i>
    </a>
    <a id="adminNavLink" href="#" onclick="navigateTo('adminRequestsPage');return false" aria-label="Admin Requests" tabindex="0" style="display:none;position:relative;">
      <i class="fa-solid fa-bell"></i>
      <span id="adminBadgeNav" class="admin-badge" aria-hidden="true" style="display:none;">0</span>
    </a>
    <a href="#" onclick="navigateTo('profilePage');return false" aria-label="User Profile" tabindex="0"><i class="fa-solid fa-user"></i></a>
  </nav>

  

  <!-- DETAILS MODAL -->
  <div id="detailsModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detailsTitle" tabindex="-1">
    <div class="modal-content">
      <button id="closeDetails" class="modal-back-btn" aria-label="Back to Machines">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h3 id="detailsTitle">Details for Machine X</h3>
      <div class="machine-details-content">
        <p id="machinePower">Power Consumption: 92.7 kW</p>
        <p id="machineStartTime">Starting Time: 08:00 AM</p>
        <p id="machineSleepTime">Sleeping Time: 05:00 PM</p>

        <section class="graph" aria-label="Machine power chart">
          <canvas id="machinePowerChart" role="img" aria-describedby="machinePowerChartDesc"></canvas>
          <p id="machinePowerChartDesc" class="sr-only">Line chart showing machine power consumption over the last 12 hours.</p>
        </section>

        <section class="graph" aria-label="Machine temperature chart">
          <canvas id="machineTempChart" role="img" aria-describedby="machineTempChartDesc"></canvas>
          <p id="machineTempChartDesc" class="sr-only">Line chart showing machine temperature levels over the last 12 hours.</p>
        </section>
      </div>
    </div>
  </div>

  <!-- PROFILE SETTINGS MODAL -->
  <div id="profileSettingsModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="profileSettingsTitle" tabindex="-1">
    <div class="modal-content">
      <button id="closeProfileSettings" class="modal-back-btn" aria-label="Back to Profile">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h3 id="profileSettingsTitle">Profile Settings</h3>
      <form id="profileSettingsForm">
        <label for="usernameInput">Username</label>
        <input type="text" id="usernameInput" placeholder="Enter new username" />
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" placeholder="Enter new email" />
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password" />
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password" />
        <label for="roleSelect">Role</label>
        <select id="roleSelect">
          <option value="admin">Admin</option>
          <option value="worker">Worker</option>
        </select>
        <label for="fontSizeSelect">Font Size</label>
        <select id="fontSizeSelect">
          <option value="small">Small</option>
          <option value="medium">Medium</option>
          <option value="large">Large</option>
        </select>
        <label for="languageSelect">Language</label>
        <select id="languageSelect">
          <option value="en">English</option>
          <option value="te">Telugu</option>
          <option value="hi">Hindi</option>
        </select>
        <button type="submit" aria-label="Save Settings">Save Settings</button>
      </form>
    </div>
  </div>

  <!-- OTP MODAL -->
  <div id="otpModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="otpTitle" tabindex="-1">
    <div class="modal-content">
      <button id="closeOtp" class="modal-back-btn" aria-label="Back to Settings">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h3 id="otpTitle">Verify OTP</h3>
      <p id="otpMessage">OTP sent to your email. Enter the 6-digit code:</p>
      <input type="text" id="otpInput" maxlength="6" pattern="\d{6}" inputmode="numeric" placeholder="------" required aria-required="true" />
      <button id="verifyOtpBtn">Verify</button>
      <button id="resendOtpBtn">Resend OTP</button>
    </div>
  </div>

  <!-- ASSISTANCE MODAL -->
  <div id="assistanceModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="assistanceTitle" tabindex="-1">
    <div class="modal-content">
      <button id="closeAssistanceBtn" class="modal-back-btn" onclick="closeAssistanceModal()" aria-label="Close Assistance Request">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h3 id="assistanceTitle">Technical Assistance Request</h3>
      <form id="assistanceModalForm">
        <label for="assistanceMachineSelect">Machine</label>
        <select id="assistanceMachineSelect" class="repair-select" required aria-required="true" aria-label="Select Machine for Assistance">
          <option value="">-- Select a Machine --</option>
        </select>
        <label for="issueNote">Issue Description</label>
        <textarea id="issueNote" placeholder="Describe the issue in detail..." required aria-required="true" aria-label="Issue Description"></textarea>
        <button type="submit" id="sendAssistanceRequestBtn">Send Request</button>
      </form>
    </div>
  </div>

  <!-- ADMIN APPROVAL MODAL -->
  <div id="adminApprovalModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="adminApprovalTitle" tabindex="-1">
    <div class="modal-content">
      <button id="closeAdminApprovalBtn" class="modal-back-btn" onclick="closeAdminApprovalModal()" aria-label="Close Pending Requests">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h3 id="adminApprovalTitle">Pending Spare Part Requests</h3>
      <div id="approvalListContainer" aria-live="polite">
        <p style="text-align:center; color:#96ded1;" id="noPendingRequests">No pending spare part requests.</p>
      </div>
    </div>
  </div>

  <button id="fabAssistance" class="fab" onclick="openAssistanceModal()" aria-label="Request Technical Assistance" style="display:none;"><i class="fa-solid fa-headset"></i></button>

  <!-- Register UI removed: authentication now uses predefined credentials -->

  <input type="file" id="uploadPic" accept="image/*" aria-label="Upload Profile Picture" hidden />

  <script>
    
    /*************************************************************************
     * SmartPlant single-file app.js (embedded) - UPDATED with Register/Login
     * - Firebase v9 compat integration
     * - Firestore users collection for authentication (Option A)
     *************************************************************************/

    // ---------------- state ----------------
    let currentUsername = "Admin User";
    let currentEmail = "admin@smartplant.com";
    let currentRole = "admin";
    let currentFontSize = "medium";
    let currentLanguage = "en";
    let lastLogin = "September 14, 2025";
    let machinesData = [
      { id: 1, name: "Primary Extruder", status: "on", power: 10.5, temperature: 55, image: "images/extruder.jpg", startTime: "08:00 AM", sleepTime: "05:00 PM" },
      { id: 2, name: "Milling Machine Alpha", status: "off", power: 0, temperature: 28, image: "images/milling.jpg", startTime: "09:00 AM", sleepTime: "06:00 PM" },
      { id: 3, name: "Chemical Mixer", status: "on", power: 8.2, temperature: 62, image: "images/mixer.jpg", startTime: "07:00 AM", sleepTime: "04:00 PM" },
      { id: 4, name: "Pressing Machine", status: "on", power: 13.1, temperature: 51, image: "images/press.jpg", startTime: "08:30 AM", sleepTime: "05:30 PM" },
      { id: 5, name: "Assembly Robot R1", status: "on", power: 5.9, temperature: 45, image: "images/robot.jpg", startTime: "06:00 AM", sleepTime: "03:00 PM" },
      { id: 6, name: "Injection Molder 3000", status: "off", power: 0, temperature: 30, image: "images/molder.jpg", startTime: "10:00 AM", sleepTime: "07:00 PM" },
      { id: 7, name: "Welding Station WS2", status: "on", power: 7.8, temperature: 59, image: "images/welding.jpg", startTime: "07:30 AM", sleepTime: "04:30 PM" },
      { id: 8, name: "Conveyor Belt Sys C5", status: "on", power: 3.5, temperature: 40, image: "images/conveyor.jpg", startTime: "06:30 AM", sleepTime: "03:30 PM" },
    ];
    let scheduledTasks = [
      { id: 101, machine: "Primary Extruder", name: "Routine Maintenance", time: "11:00" },
      { id: 102, machine: "Milling Machine Alpha", name: "System Check", time: "14:30" },
      { id: 103, machine: "Assembly Robot R1", name: "Calibration", time: "16:00" },
    ];
    // machineHistory: daily summary for past N days per machine
    let machineHistory = []; // { machineId, machineName, date, avgPower, avgTemp, energyKwh }
    let activityLogs = [
      "Logged in as admin on September 14, 2025, 10:00 AM",
      "Routine Maintenance scheduled for Primary Extruder at 11:00",
    ];
    let otp = null;
    let pendingUpdates = null;
    const TEMP_LIMIT = 60;
    const POWER_LIMIT = 12;
    const localization = {
      en: {
        loginHeading: "Smart Plant Login",
        loginButton: "Log In",
        machinePageTitle: "Machines",
        dashboardTitle: "Smart Plant",
        schedulePageTitle: "Schedule Machinery Task",
        profileSettingsTitle: "Profile Settings",
        settingsButton: "Settings",
        logoutButton: "Logout",
        alertHighTemp: "High Temperature Alert",
        alertHighPower: "High Power Consumption",
        alertsHeading: "Alerts"
      },
      te: {
        loginHeading: "స్మార్ట్‌ప్లాంట్ లాగిన్",
        loginButton: "లాగిన్",
        machinePageTitle: "యంత్రాలు",
        dashboardTitle: "డాష్‌బోర్డ్",
        schedulePageTitle: "యంత్రాల పని షెడ్యూల్",
        profileSettingsTitle: "ప్రొఫైల్ సెట్టింగ్‌లు",
        settingsButton: "సెట్టింగ్‌లు",
        logoutButton: "లాగౌట్",
        alertHighTemp: "అధిక ఉష్ణోగ్రత హెచ్చరిక",
        alertHighPower: "అधిక विद्युत खपत",
        alertsHeading: "హెచ్చరికలు"
      },
      hi: {
        loginHeading: "स्मार्टप्लांट लॉगिन",
        loginButton: "लॉग ইন کریں",
        machinePageTitle: "मशीनें",
        dashboardTitle: "डैशबोर्ड",
        schedulePageTitle: "मशीनरी कार्य शेड्यूल करें",
        profileSettingsTitle: "प्रोफ़ाइल सेटिंग्स",
        settingsButton: "सेटिंग्स",
        logoutButton: "लॉग आउट",
        alertHighTemp: "उच्च तापमान चेतावनी",
        alertHighPower: "उच्च बिजली खपत",
        alertsHeading: "अलर्ट्स"
      }
    };
    const fontSizeMap = { small: "14px", medium: "16px", large: "18px" };

    // ---------------------- Firebase config integration ----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyByyuRzgvCApBlULdFQDoZrpuoh_2_lAgA",
      authDomain: "smartplant-ef73c.firebaseapp.com",
      projectId: "smartplant-ef73c",
      storageBucket: "smartplant-ef73c.firebasestorage.app",
      messagingSenderId: "416452187426",
      appId: "1:416452187426:web:941754f2f6be879fbac17b",
      measurementId: "G-BD7BDB7RXP"
    };
    // --------------------------------------------------------------------------------------------------

    // Firebase objects
    function initFirebase() {
      if (window.firebaseInitialized) return;
      try {
        // initialize using compat SDK loaded via script tags
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        window.storage = firebase.storage();
        window.firebaseInitialized = true;

        // sign in anonymously (for quick testing). For production use proper auth.
        auth.signInAnonymously().catch(err => console.error("Firebase auth error:", err));

        // realtime listener for spareRequests (keeps admin modal in sync)
        db.collection('spareRequests').onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = { id: change.doc.id, ...change.doc.data() };
            if (change.type === 'added') {
              if (!spareRequests.find(r => r.id === data.id)) spareRequests.push(data);
              // notify admins about new spare requests (in-app + desktop)
              try {
                if (currentRole === 'admin') {
                  showNotification(`New spare request: ${data.partName} for ${data.machine}`);
                  showDesktopNotification('New Spare Request', `${data.partName} for ${data.machine} by ${data.requester}`);
                  // visual badge + audible alert
                  incrementAdminBadge(); playAdminBeep();
                    // also push to alerts collection so it shows in alerts page
                    try{ db.collection('alerts').add({ type:'SpareRequest', message:`Spare request: ${data.partName} for ${data.machine}`, timestamp: new Date().toISOString(), meta: { requester: data.requester, machine: data.machine, part: data.partName } }); }catch(e){}
                  // also ensure admin UI is visible
                  if (!document.getElementById('adminRequestsPage').classList.contains('active')) {
                    // lightly draw attention by toggling the admin button if present
                    const adminBtn = document.getElementById('adminApprovalBtnHeader'); if (adminBtn) adminBtn.style.display='block';
                  }
                }
              } catch(e){}
            } else if (change.type === 'modified') {
              const idx = spareRequests.findIndex(r => r.id === data.id);
              if (idx >= 0) spareRequests[idx] = data;
              // notify requester if their request status changed
              try { if (data.requester && data.requester === currentUsername) showNotification(`Your spare request #${data.id} status: ${data.status}`); } catch(e){}
            } else if (change.type === 'removed') {
              spareRequests = spareRequests.filter(r => r.id !== data.id);
            }
          });
          // refresh admin modal list if open
          const adminModal = document.getElementById('adminApprovalModal');
          if (adminModal && adminModal.getAttribute('aria-hidden') === 'false') refreshApprovalList();
          const adminPage = document.getElementById('adminRequestsPage');
          if (adminPage && adminPage.classList.contains('active')) renderAdminRequestsPage();
        }, err => console.error("Firestore spareRequests listener error:", err));

        // realtime listener for assistanceRequests
        db.collection('assistanceRequests').onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = { id: change.doc.id, ...change.doc.data() };
            if (change.type === 'added') {
              assistanceRequests.push(data);
              try {
                if (currentRole === 'admin') {
                  showNotification(`New assistance request for ${data.machine} by ${data.requester}`);
                  showDesktopNotification('New Assistance Request', `${data.machine} — ${data.issue} by ${data.requester}`);
                  // visual badge + audible alert
                  incrementAdminBadge(); playAdminBeep();
                    try{ db.collection('alerts').add({ type:'AssistanceRequest', message:`Assistance request for ${data.machine}: ${data.issue}`, timestamp: new Date().toISOString(), meta:{ requester:data.requester, machine:data.machine, issue:data.issue } }); }catch(e){}
                }
              } catch(e){}
            } else if (change.type === 'modified') {
              const idx = assistanceRequests.findIndex(r => r.id === data.id);
              if (idx >= 0) assistanceRequests[idx] = data;
              try { if (data.requester && data.requester === currentUsername) showNotification(`Your assistance ticket #${data.id} status: ${data.status}`); } catch(e){}
            } else if (change.type === 'removed') {
              assistanceRequests = assistanceRequests.filter(r => r.id !== data.id);
            }
          });
          const adminPage2 = document.getElementById('adminRequestsPage');
          if (adminPage2 && adminPage2.classList.contains('active')) renderAdminRequestsPage();
        }, err => console.error("Firestore assistanceRequests listener error:", err));
        // realtime listener for alerts collection
        try {
          db.collection('alerts').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
              const data = { id: change.doc.id, ...change.doc.data() };
              if (change.type === 'added') {
                if (!window.alertsHistory) window.alertsHistory = [];
                if (!window.alertsHistory.find(a=>a.id===data.id)) window.alertsHistory.push(data);
                // notify admins immediately
                try { if (currentRole === 'admin') { showNotification(data.message || 'New alert'); showDesktopNotification('Alert', data.message || 'New alert'); incrementAdminBadge(); playAdminBeep(); } } catch(e){}
              } else if (change.type === 'removed') {
                window.alertsHistory = (window.alertsHistory||[]).filter(a=>a.id!==data.id);
              }
            });
            // refresh admin alerts history when adminPage open
            const adminPage = document.getElementById('adminRequestsPage'); if (adminPage && adminPage.classList.contains('active')) renderAdminRequestsPage();
            // refresh dashboard alerts list
            try{ checkAndShowAlerts(); }catch(e){}
          }, err=>console.error('Firestore alerts listener error', err));
        } catch(e) {}
      } catch (e) {
        console.warn("initFirebase failed:", e);
      }
    }

    // Save spare request to Firestore (best-effort)
    async function saveSpareRequestToFirebase(request) {
      if (!window.db) return null;
      try {
        const payload = {
          machine: request.machine,
          partName: request.partName,
          fileName: request.fileName,
          quantity: request.quantity,
          requester: request.requester,
          timestamp: request.timestamp,
          eta: request.eta,
          status: request.status
        };
        const docRef = await db.collection('spareRequests').add(payload);
        request.id = docRef.id;
        // try to replace local placeholder id if exists
        const idx = spareRequests.findIndex(r => r._localId && r._localId === request._localId);
        if (idx >= 0) spareRequests[idx].id = docRef.id;
        return docRef.id;
      } catch (err) {
        console.error("saveSpareRequestToFirebase error:", err);
        return null;
      }
    }

    async function saveAssistanceToFirebase(request) {
      if (!window.db) return null;
      try {
        const payload = {
          machine: request.machine,
          issue: request.issue,
          requester: request.requester,
          timestamp: request.timestamp,
          status: request.status
        };
        const docRef = await db.collection('assistanceRequests').add(payload);
        request.id = docRef.id;
        return docRef.id;
      } catch (err) {
        console.error("saveAssistanceToFirebase error:", err);
        return null;
      }
    }

    // create an alert (local history + optional Firestore write)
    async function createAlert(type, message, meta = {}) {
      try {
        if (typeof alertsHistory === 'undefined') window.alertsHistory = [];
        const item = { id: 'alert-' + Date.now(), type, message, timestamp: new Date().toISOString(), meta };
        window.alertsHistory.push(item);
        checkAndShowAlerts();
        if (window.db) {
          try { await db.collection('alerts').add(item); } catch(e) { console.warn('Failed to write alert to Firestore', e); }
        }
        // broadcast via localStorage as a fallback for admin clients on same origin
        try { localStorage.setItem('smartplant_alert', JSON.stringify(item)); } catch(e) {}
      } catch(e) { console.error('createAlert error', e); }
    }

    // Load machines/spareCatalog/scheduledTasks/activityLogs from Firestore (if present)
    async function loadInitialData() {
      if (!window.db) return;
      try {
        const machinesSnap = await db.collection('machines').get();
        if (!machinesSnap.empty) machinesData = machinesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const catalogSnap = await db.collection('spareCatalog').get();
        if (!catalogSnap.empty) {
          const catalog = {};
          catalogSnap.docs.forEach(doc => {
            const d = doc.data();
            if (d.machineName && Array.isArray(d.parts)) catalog[d.machineName] = d.parts;
          });
          if (Object.keys(catalog).length) Object.assign(sparePartsCatalog, catalog);
        }

        const tasksSnap = await db.collection('scheduledTasks').get();
        if (!tasksSnap.empty) scheduledTasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const logsSnap = await db.collection('activityLogs').orderBy('timestamp','desc').limit(100).get();
        if (!logsSnap.empty) activityLogs = logsSnap.docs.map(d => d.data().text || '');
      } catch (e) {
        console.warn("loadInitialData failed:", e);
      }
    }

    // Navigation & UI
    function navigateTo(pageId) {
      document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
      const targetPage = document.getElementById(pageId);
      if (targetPage) targetPage.classList.add("active");
      updateBottomNavActive(pageId);
      checkAndShowAlerts();

      const bottomNav = document.getElementById('bottomNav');
      const fabAssistance = document.getElementById('fabAssistance');
      if (pageId === "loginPage") {
        document.title = localization[currentLanguage].loginHeading;
        bottomNav.style.display = "none";
        fabAssistance.style.display = "none";
      } else if (pageId === "dashboardPage") {
        document.title = "SmartPlant | " + localization[currentLanguage].dashboardTitle;
        initDashboard();
        updateUpcomingTasks();
        bottomNav.style.display = "flex";
        fabAssistance.style.display = "none";
      } else if (pageId === "machinesPage") {
        document.title = "SmartPlant | " + localization[currentLanguage].machinePageTitle;
        initMachines();
        bottomNav.style.display = "flex";
        fabAssistance.style.display = "none";
      } else if (pageId === "schedulePage") {
        document.title = "SmartPlant | " + localization[currentLanguage].schedulePageTitle;
        document.getElementById("machineName").value = "";
        bottomNav.style.display = "flex";
        fabAssistance.style.display = "none";
      } else if (pageId === "adminRequestsPage") {
        document.title = "SmartPlant | Admin Requests";
        if (currentRole !== 'admin') { showNotification("Access Denied: Admins only."); navigateTo('dashboardPage'); return; }
        renderAdminRequestsPage();
        bottomNav.style.display = "flex";
        fabAssistance.style.display = "none";
        clearAdminBadge();
      } else if (pageId === "profilePage") {
        document.title = "SmartPlant | Profile";
        document.getElementById("profileLastLogin").textContent = `Last Login: ${lastLogin}`;
        document.getElementById("profileRole").textContent = `Role: ${currentRole.charAt(0).toUpperCase() + currentRole.slice(1)}`;
        document.getElementById("activityLogList").innerHTML = activityLogs.map(log => `<li>${log}</li>`).join('');
        bottomNav.style.display = "flex";
        fabAssistance.style.display = "none";
      } else if (pageId === "repairPage") {
        document.title = "SmartPlant | Repair & Spare Parts";
        if (currentRole === 'admin') {
            showNotification("Access Denied: Spare part requests are for workers only.");
            navigateTo('dashboardPage');
            return;
        }
        populateRepairMachineSelect();
        bottomNav.style.display = "flex";
        fabAssistance.style.display = currentRole === 'worker' ? "flex" : "none";
      }
    }

    function initializeThemeToggle() {
      const toggles = ["themeToggleSlider", "themeToggleSlider2", "themeToggleSlider3", "themeToggleSlider4", "themeToggleSlider5", "themeToggleSlider6"].map(id => document.getElementById(id)).filter(Boolean);
      document.body.classList.add("dark-theme");
      toggles.forEach(t => { t.checked = true; });
      toggles.forEach(toggle => {
        toggle.addEventListener("change", () => {
          const dark = toggle.checked;
          toggles.forEach(t => { if (t !== toggle) t.checked = dark; });
          if (dark) document.body.classList.add("dark-theme");
          else document.body.classList.remove("dark-theme");
        });
      });
    }

    function updateBottomNavActive(pageId) {
      document.querySelectorAll(".bottom-nav a").forEach(a => a.classList.remove("active"));
      const navLinks = document.querySelectorAll(".bottom-nav a");
      let index = -1;
      if (pageId === 'dashboardPage') index = 0;
      else if (pageId === 'machinesPage') index = 1;
      else if (pageId === 'schedulePage') index = 2;
      else if (pageId === 'repairPage') index = currentRole === 'worker' ? 3 : -1;
      else if (pageId === 'adminRequestsPage') index = currentRole === 'admin' ? 3 : -1;
      else if (pageId === 'profilePage') index = 4;
      if (index !== -1 && index < navLinks.length) navLinks[index].classList.add("active");
    }

    function updateLanguageTexts(lang) {
      const loginHeadingEl = document.querySelector("#loginPage header h2");
      if (loginHeadingEl) loginHeadingEl.textContent = localization[lang].loginHeading;
      const loginBtn = document.querySelector("#loginForm button[type='submit']");
      if (loginBtn) loginBtn.textContent = localization[lang].loginButton;
      const dashboardTitle = document.querySelector("#dashboardPage header h2");
      if (dashboardTitle) dashboardTitle.textContent = localization[lang].dashboardTitle;
      const scheduleTitle = document.querySelector("#schedulePage header h2");
      if (scheduleTitle) scheduleTitle.textContent = localization[lang].schedulePageTitle;
      const profileSettingsTitle = document.getElementById("profileSettingsTitle");
      if (profileSettingsTitle) profileSettingsTitle.textContent = localization[lang].profileSettingsTitle;
      const openSettingsBtn = document.getElementById("openProfileSettingsBtn");
      if (openSettingsBtn) openSettingsBtn.textContent = localization[lang].settingsButton;
      const logoutBtn = document.querySelector("#profilePage button[aria-label='Logout']");
      if (logoutBtn) logoutBtn.textContent = localization[lang].logoutButton;
      const alertsHeading = document.querySelector("#alertSection h3");
      if (alertsHeading) alertsHeading.textContent = localization[lang].alertsHeading;
    }

    function showLoader() { document.getElementById("loader").style.display = "flex"; }
    function hideLoader() { document.getElementById("loader").style.display = "none"; }
    function showNotification(message) {
      document.getElementById("notificationMessage").textContent = message;
      document.getElementById("notification").style.display = "block";
    }

    // Desktop notification helper (requests permission on first use)
    function showDesktopNotification(title, body) {
      try {
        if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
          const n = new Notification(title, { body });
        } else if (typeof Notification !== 'undefined' && Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => { if (permission === 'granted') new Notification(title, { body }); });
        }
        // also play a short beep using WebAudio for attention
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator(); const g = ctx.createGain();
          o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
          o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 200);
        } catch(e){}
      } catch (e) { console.warn('Desktop notification failed', e); }
    }

    // Admin badge & beep helpers
    function incrementAdminBadge() {
      try {
        const ids = ['adminBadge','adminBadgeNav'];
        ids.forEach(id => {
          const b = document.getElementById(id);
          if (!b) return;
          let n = parseInt(b.textContent||'0')||0; n++;
          b.textContent = n;
          b.style.display = 'inline-block';
          b.setAttribute('data-count', String(n));
        });
      } catch(e){}
    }
    function clearAdminBadge() {
      try {
        ['adminBadge','adminBadgeNav'].forEach(id=>{ const b = document.getElementById(id); if (!b) return; b.textContent='0'; b.style.display='none'; b.setAttribute('data-count','0'); });
      } catch(e){}
    }
    function playAdminBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 1000; g.gain.value = 0.04;
        o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 220);
      } catch(e){}
    }

    // ----------------- AUTH: Login only (predefined credentials) -----------------

    // Predefined credentials:
    // worker -> id: abcdefg  password: 123456  role: worker
    // admin  -> id: admin    password: 123456  role: admin

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const uid = document.getElementById("userId").value.trim();
      const pwd = document.getElementById("password").value;

      if (uid.length < 1 || pwd.length < 1) {
        showNotification("Please enter User ID and Password.");
        return;
      }

      showLoader();
      try {
        // Check predefined credentials
        if (uid === 'abcdefg' && pwd === '123456') {
          currentRole = 'worker';
          currentUsername = uid;
        } else if (uid === 'admin' && pwd === '123456') {
          currentRole = 'admin';
          currentUsername = uid;
        } else {
          hideLoader();
          showNotification('Invalid User ID or Password');
          return;
        }

        lastLogin = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        activityLogs.push(`Logged in as ${currentRole} on ${new Date().toLocaleString()}`);
        document.getElementById("profileName").textContent = currentUsername;
        document.getElementById("profileEmail").textContent = `${currentUsername}@smartplant.local`;

        // Navigate
        navigateTo("dashboardPage");
        initDashboard();
        initMachines();

        showNotification(`Welcome ${currentUsername} (${currentRole})`);

        // Show/Hide Repair or Admin options
        const repairNav = document.getElementById("repairNavLink");
        const adminBtn = document.getElementById("adminApprovalBtnHeader");

        if (currentRole === "worker") {
            if (repairNav) repairNav.style.display = "block";
            if (adminBtn) adminBtn.style.display = "none";
        } else if (currentRole === "admin") {
            if (repairNav) repairNav.style.display = "none";
            if (adminBtn) adminBtn.style.display = "block";
        }
        hideLoader();
      } catch (error) {
        hideLoader();
        console.error("Login error:", error);
        showNotification("Login failed!");
      }
    });

    // --- Logout ---
    function logout(){
      activityLogs.push(`Logged out on ${new Date().toLocaleString()}`);
      navigateTo("loginPage");
      document.getElementById("loginForm").reset();
      document.getElementById("profilePic").src="images/profile.jpg";
      scheduledTasks = [];
      activityLogs = [];
      document.getElementById("repairNavLink").style.display = "none";
      const adminBtn = document.getElementById("adminApprovalBtnHeader");
      if (adminBtn) adminBtn.style.display = "none";
    }

    // --- Modal Functions ---
    const detailsModal=document.getElementById("detailsModal");
    const closeDetailsBtn=document.getElementById("closeDetails");
    closeDetailsBtn.addEventListener("click",closeDetails);
    function openDetails(machine) {
      document.getElementById("detailsTitle").textContent = `Details for ${machine.name}`;
      document.getElementById("machinePower").textContent = `Power Consumption: ${machine.power} kW`;
      document.getElementById("machineStartTime").textContent = `Starting Time: ${machine.startTime}`;
      document.getElementById("machineSleepTime").textContent = `Sleeping Time: ${machine.sleepTime}`;
      initMachineCharts(machine);
      detailsModal.setAttribute("aria-hidden","false");
      detailsModal.style.display="flex";
      detailsModal.focus();
    }
    function closeDetails(){
      detailsModal.setAttribute("aria-hidden","true");
      detailsModal.style.display="none";
      try { if (machinePowerChart) machinePowerChart.destroy(); } catch(e){}
      try { if (machineTempChart) machineTempChart.destroy(); } catch(e){}
    }

    const profileSettingsModal=document.getElementById("profileSettingsModal");
    const openProfileSettingsBtn=document.getElementById("openProfileSettingsBtn");
    const closeProfileSettingsBtn=document.getElementById("closeProfileSettings");
    const profileSettingsForm=document.getElementById("profileSettingsForm");

    openProfileSettingsBtn.addEventListener("click", () => {
      document.getElementById("usernameInput").value = currentUsername;
      document.getElementById("emailInput").value = currentEmail;
      document.getElementById("roleSelect").value = currentRole;
      document.getElementById("fontSizeSelect").value = currentFontSize;
      document.getElementById("languageSelect").value = currentLanguage;
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";
      profileSettingsModal.setAttribute("aria-hidden", "false");
      profileSettingsModal.style.display = "flex";
      profileSettingsModal.focus();
    });

    closeProfileSettingsBtn.addEventListener("click", closeProfileSettings);
    function closeProfileSettings() {
      profileSettingsModal.setAttribute("aria-hidden","true");
      profileSettingsModal.style.display="none";
    }

    function saveSettings(e) {
      e.preventDefault();
      const formData = {
        username: document.getElementById("usernameInput").value.trim(),
        email: document.getElementById("emailInput").value.trim(),
        newPassword: document.getElementById("newPassword").value,
        confirmPassword: document.getElementById("confirmPassword").value,
        role: document.getElementById("roleSelect").value,
        fontSize: document.getElementById("fontSizeSelect").value,
        language: document.getElementById("languageSelect").value,
      };

      if (formData.newPassword && formData.newPassword !== formData.confirmPassword) {
        showNotification("New Password and Confirm Password do not match.");
        return;
      }

      if (formData.newPassword && formData.newPassword.length < 6) {
          showNotification("Password must be at least 6 characters.");
          return;
      }

      if (formData.username !== currentUsername || formData.email !== currentEmail || formData.newPassword || formData.role !== currentRole || formData.fontSize !== currentFontSize || formData.language !== currentLanguage) {
        pendingUpdates = formData;
        sendOTP();
      } else {
        closeProfileSettings();
        showNotification("No changes detected.");
      }
    }

    function sendOTP() {
      otp = Math.floor(100000 + Math.random() * 900000).toString();
      const otpModal = document.getElementById("otpModal");
      otpModal.setAttribute("aria-hidden", "false");
      otpModal.style.display = "flex";
      otpModal.focus();
      document.getElementById("otpInput").focus();
      showNotification(`OTP sent to ${pendingUpdates.email || currentEmail}`);
    }

    // --- OTP Modal Functions ---
    const otpModal = document.getElementById("otpModal");
    const closeOtpBtn = document.getElementById("closeOtp");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const resendOtpBtn = document.getElementById("resendOtpBtn");
    const otpInput = document.getElementById("otpInput");

    closeOtpBtn.addEventListener("click", closeOtpModal);
    verifyOtpBtn.addEventListener("click", verifyOtp);
    resendOtpBtn.addEventListener("click", resendOtp);
    otpInput.addEventListener("keypress", (e) => { if (e.key === "Enter") verifyOtp(); });
    otpModal.addEventListener("click", (e) => { if (e.target === otpModal) closeOtpModal(); });

    function closeOtpModal() {
      document.getElementById("otpModal").setAttribute("aria-hidden", "true");
      document.getElementById("otpModal").style.display = "none";
      otp = null;
      pendingUpdates = null;
      document.getElementById("otpInput").value = "";
    }

    function verifyOtp() {
      const userOtp = document.getElementById("otpInput").value.trim();
      if (userOtp.length !== 6 || !/^\d{6}$/.test(userOtp)) {
        showNotification("Please enter a valid 6-digit OTP.");
        return;
      }
      if (userOtp === otp) {
        applyUpdates(pendingUpdates);
        closeOtpModal();
        closeProfileSettings();
        showNotification("Profile settings saved successfully.");
        if (pendingUpdates.newPassword) activityLogs.push(`Password changed on ${new Date().toLocaleString()}`);
        activityLogs.push(`Profile updated on ${new Date().toLocaleString()}`);

        // Re-run RBAC check after role update
        const repairNav = document.getElementById("repairNavLink");
        const adminBtn = document.getElementById("adminApprovalBtnHeader");
        if (currentRole === "worker") { repairNav.style.display = "block"; if (adminBtn) adminBtn.style.display = "none"; }
        else if (currentRole === "admin") { repairNav.style.display = "none"; if (adminBtn) adminBtn.style.display = "block"; }
        else { repairNav.style.display = "none"; if (adminBtn) adminBtn.style.display = "none"; }
      } else {
        showNotification("Invalid OTP. Please try again.");
        document.getElementById("otpInput").value = "";
        document.getElementById("otpInput").focus();
      }
    }

    function resendOtp() {
      if (pendingUpdates) {
        otp = Math.floor(100000 + Math.random() * 900000).toString();
        showNotification(`New OTP sent to ${pendingUpdates.email || currentEmail}`);
      }
    }

    function applyUpdates(updates) {
      currentUsername = updates.username || currentUsername;
      currentEmail = updates.email || currentEmail;
      if (updates.newPassword) { /* simulated password change */ }
      currentRole = updates.role;
      currentFontSize = updates.fontSize;
      currentLanguage = updates.language;

      document.getElementById("profileName").textContent = currentUsername;
      document.getElementById("profileRole").textContent = `Role: ${currentRole.charAt(0).toUpperCase() + currentRole.slice(1)}`;
      document.getElementById("profileEmail").textContent = currentEmail;
      document.getElementById(currentRole + "Radio").checked = true;
      document.body.style.fontSize = fontSizeMap[currentFontSize];
      updateLanguageTexts(currentLanguage);
    }

    // --- Charts ---
    let energyChart,tempChart,machinePowerChart,machineTempChart,monthlyChart;
    function getChartOptions(color){
      return {
        responsive:true,
        interaction:{mode:"nearest",intersect: false},
        plugins: { tooltip:{enabled:true}, legend:{labels:{color:color,font:{weight:"bold"}}} },
        scales: { x:{ticks:{color:color,font:{weight:"600"}},grid:{color:color,borderDash:[4,4]}}, y:{ticks:{color:color,font:{weight:"600"}},grid:{color:color,borderDash:[4,4]},beginAtZero:true} }
      };
    }

    function initDashboard(){
      const ctxE=document.getElementById("energyChart").getContext("2d");
      const ctxT=document.getElementById("tempChart").getContext("2d");
      const darkMode=document.body.classList.contains("dark-theme");
      const energyColor=darkMode?"#26a69a":"#00796b";
      const tempColor=darkMode?"#e65100":"#d84315";
      if(energyChart) energyChart.destroy();
      if(tempChart) tempChart.destroy();
      energyChart=new Chart(ctxE,{
        type:"line",
        data:{ labels:Array.from({length:12},(_,i)=>`${i+1}h`), datasets:[{ label:"Power (kW)", data:Array.from({length:12},()=>Math.floor(Math.random()*100)), borderColor:energyColor, backgroundColor:"rgba(38,166,154,0.2)", fill:true, tension:0.3,borderWidth:2,pointRadius:4,pointHoverRadius:6 }] },
        options:getChartOptions(energyColor)
      });
      tempChart=new Chart(ctxT,{
        type:"line",
        data:{ labels:Array.from({length:12},(_,i)=>`${i+1}h`), datasets:[{ label:"Temperature (°C)", data:Array.from({length:12},()=>20+Math.floor(Math.random()*15)), borderColor:tempColor, backgroundColor:"rgba(230,81,0,0.2)", fill:true, tension:0.3,borderWidth:2,pointRadius:4,pointHoverRadius:6 }] },
        options:getChartOptions(tempColor)
      });
      // slower, more realistic chart cadence
      if (window._chartUpdateInterval) clearInterval(window._chartUpdateInterval);
      window._chartUpdateInterval = setInterval(()=> {
        try {
          energyChart.data.datasets[0].data.shift();
          energyChart.data.datasets[0].data.push(Math.floor(Math.random()*100));
          energyChart.update();
          tempChart.data.datasets[0].data.shift();
          tempChart.data.datasets[0].data.push(20+Math.floor(Math.random()*15));
          tempChart.update();
          updateActiveMachines();
        } catch(e){}
      },8000);

      // update total energy independently and less frequently
      if (window._energyUpdateInterval) clearInterval(window._energyUpdateInterval);
      window._energyUpdateInterval = setInterval(()=>{ try{ updateTotalEnergy(); }catch(e){} },15000);

      if (currentRole === 'admin') {
        document.getElementById('monthlyGraph').style.display = 'block';
        document.getElementById('adminLogsSection').style.display = 'block';
        document.getElementById('allActivityLogs').innerHTML = activityLogs.map(log => `<li>${log}</li>`).join('');
        const ctxM = document.getElementById("monthlyChart").getContext("2d");
        const monthlyColor = darkMode ? "#26a69a" : "#00796b";
        if (monthlyChart) monthlyChart.destroy();
        monthlyChart = new Chart(ctxM, {
          type: "bar",
          data: {
            labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
            datasets: [{ label: "Energy (kWh)", data: Array.from({length: 12}, () => Math.floor(Math.random() * 10000 + 5000)), backgroundColor: "rgba(38,166,154,0.7)", borderColor: monthlyColor, borderWidth: 1 }]
          },
          options: getChartOptions(monthlyColor)
        });
      } else {
        document.getElementById('monthlyGraph').style.display = 'none';
        document.getElementById('adminLogsSection').style.display = 'none';
      }
    }

    let totalEnergyValue = 456;
    function updateTotalEnergy() {
      const el = document.getElementById("totalEnergy");
      if (!el) return;
      const delta = Math.floor(Math.random() * 5) - 2; // small change each tick
      totalEnergyValue = Math.max(50, totalEnergyValue + delta);
      el.textContent = `${totalEnergyValue} kWh`;
    }

    function initMachineCharts(machine) {
      const ctxP = document.getElementById("machinePowerChart").getContext("2d");
      const ctxT = document.getElementById("machineTempChart").getContext("2d");
      const darkMode = document.body.classList.contains("dark-theme");
      const powerColor = darkMode ? "#26a69a" : "#00796b";
      const tempColor = darkMode ? "#e65100" : "#d84315";
      if (machinePowerChart) machinePowerChart.destroy();
      if (machineTempChart) machineTempChart.destroy();

      machinePowerChart = new Chart(ctxP, {
        type: "line",
        data: {
          labels: Array.from({length: 12}, (_, i) => `${i + 1}h`),
          datasets: [{ label: "Power (kW)", data: Array.from({length: 12}, () => (Math.random() * 15 + 5).toFixed(1)), borderColor: powerColor, backgroundColor: "rgba(38,166,154,0.2)", fill: true, tension: 0.3, borderWidth: 2, pointRadius: 4, pointHoverRadius: 6 }]
        },
        options: getChartOptions(powerColor)
      });

      machineTempChart = new Chart(ctxT, {
        type: "line",
        data: {
          labels: Array.from({length: 12}, (_, i) => `${i + 1}h`),
          datasets: [{ label: "Temperature (°C)", data: Array.from({length: 12}, () => (Math.random() * 10 + 40).toFixed(1)), borderColor: tempColor, backgroundColor: "rgba(230,81,0,0.2)", fill: true, tension: 0.3, borderWidth: 2, pointRadius: 4, pointHoverRadius: 6 }]
        },
        options: getChartOptions(tempColor)
      });
    }

    // --- Machines & Alerts ---
    function updateActiveMachines() {
      const activeCount = machinesData.filter(m => m.status === 'on').length;
      document.getElementById("activeMachines").textContent = `${activeCount}/${machinesData.length}`;
    }
    function initMachines() {
      const machineList = document.getElementById("machineList");
      machineList.innerHTML = "";
      machinesData.forEach(machine => {
        const hasError = machine.temperature > TEMP_LIMIT || machine.power > POWER_LIMIT;
        const dotClass = hasError ? 'status-off' : 'status-on';
        const card = document.createElement("div");
        card.className = "machine-card";
        // mark chemical mixer for special styling
        if (machine.name === "Chemical Mixer") card.classList.add('chemical-mixer');
        card.setAttribute("tabindex", "0");

        // force display for Chemical Mixer
        const isChemical = machine.name === "Chemical Mixer";
        const tempValue = isChemical ? 62 : machine.temperature;
        const tempClass = isChemical ? 'red-highlight chemical-temp' : (machine.temperature > TEMP_LIMIT ? 'red-highlight' : '');

        card.innerHTML = `
          <img src="${machine.image}" alt="${machine.name}" class="machine-img" />
          <h3>${machine.name}</h3>
          <p>Status: <span class="${machine.status === 'on' ? 'status-on' : 'status-off'}">${machine.status.toUpperCase()}</span></p>
          <p>Power: <span>${machine.power} kW</span></p>
          <p>Temp: <span class="${tempClass}">${tempValue} °C</span></p>
          <button class="details-btn" data-machine-id="${machine.id}">Details</button>
          <button class="schedule-btn" data-machine-name="${machine.name}">Schedule</button>
          <span class="machine-status ${dotClass}">
            <i class="fa-solid fa-circle"></i>
          </span>
        `;
        machineList.appendChild(card);
      });

      document.querySelectorAll(".details-btn").forEach(button => {
        button.addEventListener("click", () => {
          const machineId = parseInt(button.dataset.machineId);
          const machine = machinesData.find(m => m.id === machineId);
          if (machine) openDetails(machine);
        });
      });

      document.querySelectorAll(".schedule-btn").forEach(button => {
        button.addEventListener("click", () => {
          const machineName = button.dataset.machineName;
          navigateTo("schedulePage");
          document.getElementById("machineName").value = machineName;
        });
      });
      try{ if (typeof populateScheduleMachineSelect === 'function') populateScheduleMachineSelect(); } catch(e){}
    }

    function checkAndShowAlerts(){
      // Keep dashboard alerts concise: show instantaneous machine faults
      // and only very recent persisted alerts that are tied to a machine.
      if (typeof alertsHistory === 'undefined') window.alertsHistory = [];
      const alertSection = document.getElementById("alertSection");
      const alertList = document.getElementById("alertList");
      alertList.innerHTML = "";
      let hasAlert = false;
      const now = Date.now();

      // Include very recent alerts persisted to alertsHistory (within last 2 minutes)
      try {
        const recent = (window.alertsHistory || []).filter(a => {
          try {
            const t = new Date(a.timestamp).getTime();
            // only surface persisted alerts that are tied to a machine to reduce noise
            return !isNaN(t) && (now - t) <= 2 * 60 * 1000 && a.meta && a.meta.machine;
          } catch(e) { return false; }
        }).slice().reverse().slice(0, 8);
        recent.forEach(a => {
          const li = document.createElement('li');
          li.textContent = `${a.message} (${new Date(a.timestamp).toLocaleTimeString()})`;
          li.style.cursor = 'pointer'; li.tabIndex = 0;
          li.addEventListener('click', () => {
            if (a.meta && a.meta.machine) {
              navigateTo('machinesPage');
              setTimeout(() => { const mach = machinesData.find(x => x.name === a.meta.machine); if (mach) openDetails(mach); }, 250);
            } else {
              navigateTo('adminRequestsPage');
            }
          });
          li.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') li.click(); });
          alertList.appendChild(li);
          hasAlert = true;
        });
      } catch(e) { console.warn('checkAndShowAlerts recent filter error', e); }

      // Immediate machine faults
      machinesData.forEach(m => {
        if (m.temperature > TEMP_LIMIT) {
          const li = document.createElement("li");
          li.textContent = `${m.name}: ${localization[currentLanguage].alertHighTemp} (${m.temperature} °C)`;
          li.setAttribute('data-machine-name', m.name);
          li.style.cursor = 'pointer'; li.tabIndex = 0;
          li.addEventListener('click', () => { navigateTo('machinesPage'); setTimeout(() => { const mach = machinesData.find(x => x.name === m.name); if (mach) openDetails(mach); }, 250); });
          li.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') li.click(); });
          alertList.appendChild(li);
          hasAlert = true;
        }
        if (m.power > POWER_LIMIT) {
          const li = document.createElement("li");
          li.textContent = `${m.name}: ${localization[currentLanguage].alertHighPower} (${m.power} kW)`;
          li.setAttribute('data-machine-name', m.name);
          li.style.cursor = 'pointer'; li.tabIndex = 0;
          li.addEventListener('click', () => { navigateTo('machinesPage'); setTimeout(() => { const mach = machinesData.find(x => x.name === m.name); if (mach) openDetails(mach); }, 250); });
          li.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') li.click(); });
          alertList.appendChild(li);
          hasAlert = true;
        }
      });

      // Show alerts panel to any role when there are relevant alerts (workers included)
      alertSection.style.display = hasAlert ? "flex" : "none";
    }

    function updateUpcomingTasks() {
      const tasksList = document.getElementById("upcomingTasksList");
      tasksList.innerHTML = "";
      // collect scheduled tasks and imminent machine on/off events
      const events = [];
      // include explicit scheduled tasks
      scheduledTasks.forEach(task => {
        // treat task.time as HH:MM or HH:MM AM/PM
        const dt = parseTimeToNextDate(task.time);
        if (dt) events.push({ when: dt, title: `${task.machine}: ${task.name}` });
      });
      // include next on/off events based on machine startTime/sleepTime
      machinesData.forEach(m => {
        try {
          if (m.startTime) {
            const dtOn = parseTimeToNextDate(m.startTime);
            if (dtOn && (dtOn - Date.now()) <= 48 * 3600 * 1000) events.push({ when: dtOn, title: `${m.name}: Scheduled ON` });
          }
          if (m.sleepTime) {
            const dtOff = parseTimeToNextDate(m.sleepTime);
            if (dtOff && (dtOff - Date.now()) <= 48 * 3600 * 1000) events.push({ when: dtOff, title: `${m.name}: Scheduled OFF` });
          }
        } catch(e){}
      });

      events.sort((a,b)=>a.when - b.when);
      events.slice(0,6).forEach(ev => {
        const li = document.createElement('li');
        li.textContent = `${formatDateTime(ev.when)} — ${ev.title}`;
        tasksList.appendChild(li);
      });
    }

    // Helper: parse a time string like "08:00 AM" or "14:30" to the next Date occurrence
    function parseTimeToNextDate(timeStr){
      if(!timeStr) return null;
      // Normalize
      const t = timeStr.trim();
      const now = new Date();
      // Try to parse with Date.parse by building a string today
      let dateStr = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()} ${t}`;
      // handle AM/PM and HH:MM
      let parsed = new Date(dateStr);
      if (isNaN(parsed.getTime())){
        // fallback: parse HH:MM and assume 24h
        const m = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
        if (!m) return null;
        let hh = parseInt(m[1],10); const mm = parseInt(m[2],10); const ampm = (m[3]||'').toUpperCase();
        if (ampm==='PM' && hh<12) hh+=12; if (ampm==='AM' && hh===12) hh=0;
        parsed = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
      }
      // If parsed time is earlier than now, move to next day
      if (parsed.getTime() <= now.getTime()) parsed = new Date(parsed.getTime() + 24*3600*1000);
      return parsed;
    }

    function formatDateTime(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      return dt.toLocaleString();
    }

    // Generate machine history for past N days (daily summaries)
    function generateMachineHistory(days=90){
      machineHistory = [];
      const now = new Date();
      for(let i=0;i<days;i++){
        const date = new Date(now.getFullYear(), now.getMonth(), now.getDate()-i);
        machinesData.forEach(m=>{
          // create realistic-ish readings based on machine's base power/temp
          const baseP = Math.max(0.5, (m.power||5));
          const baseT = Math.max(25, (m.temperature||40));
          const varianceP = (Math.random()*0.3 + 0.85);
          const varianceT = (Math.random()*4 - 2);
          const avgPower = +(baseP * varianceP).toFixed(2);
          const avgTemp = Math.round(baseT + varianceT);
          const energyKwh = +(avgPower * (8 + Math.random()*8)).toFixed(2); // 8-16 hours equivalent
          machineHistory.push({ machineId: m.id, machineName: m.name, date: date.toISOString().slice(0,10), avgPower, avgTemp, energyKwh });
        });
      }
    }

    // --- Schedule/Report ---
    document.getElementById("saveTask").addEventListener("click", async () => {
      const machineNameInput = document.getElementById("machineName");
      const scheduleSelect = document.getElementById("scheduleMachineSelect");
      if (scheduleSelect && scheduleSelect.value) machineNameInput.value = scheduleSelect.value;
      const taskNameInput = document.getElementById("taskName");
      const taskTimeInput = document.getElementById("taskTime");
      const machineName = machineNameInput.value.trim();
      const taskName = taskNameInput.value.trim();
      const taskTime = taskTimeInput.value.trim();
      if (!machineName || !taskName || !taskTime) {
        showNotification("Please fill in all task details.");
        return;
      }
      showLoader();
      setTimeout(async () => {
        hideLoader();
        const newTask = { id: Date.now(), machine: machineName, name: taskName, time: taskTime };
        scheduledTasks.push(newTask);
        showNotification(`Task "${taskName}" successfully scheduled for ${machineName} at ${taskTime}.`);
        activityLogs.push(`Task scheduled: ${taskName} for "${machineName}" at ${taskTime}.`);
        taskNameInput.value="";
        taskTimeInput.value="";
        navigateTo("dashboardPage");
        // persist to Firestore
        try {
          if (window.db) await db.collection('scheduledTasks').add(newTask);
        } catch(e){}
      },900);
    });

      // Populate schedule machine select
      function populateScheduleMachineSelect() {
        const sel = document.getElementById('scheduleMachineSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- Select a Machine --</option>';
        machinesData.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.name;
          opt.textContent = m.name;
          sel.appendChild(opt);
        });
        sel.addEventListener('change', () => {
          document.getElementById('machineName').value = sel.value;
        });
      }

    // --- Profile picture upload (uses FileReader locally; optional Storage upload) ---
    document.getElementById("uploadPic").addEventListener("change", async e=>{
      const file=e.target.files[0];
      if(!file) return;
      if(!file.type.startsWith("image/")){showNotification("Please upload a valid image file."); return;}
      const reader=new FileReader();
      reader.onload=function(event){
        document.getElementById("profilePic").src=event.target.result;
        activityLogs.push(`Profile picture updated on ${new Date().toLocaleString()}`);
      };
      reader.readAsDataURL(file);

      // Optional: upload to Firebase Storage and save URL in Firestore (uncomment if desired)
      /*
      if (window.storage && currentUsername) {
        const storageRef = storage.ref().child(`profiles/${currentUsername}_${Date.now()}`);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed',
          snapshot => {},
          error => { console.error(error); },
          async () => {
            const url = await uploadTask.snapshot.ref.getDownloadURL();
            document.getElementById("profilePic").src = url;
            // save URL to user's profile doc if you have one
          }
        );
      }
      */
    });

    window.addEventListener("load",()=>{
      initializeThemeToggle();
      document.body.style.fontSize = fontSizeMap[currentFontSize];
      updateLanguageTexts(currentLanguage);
      document.getElementById('bottomNav').style.display = 'none';
      const uploadLabel=document.querySelector(".upload-pic-label");
      if(uploadLabel){ uploadLabel.setAttribute("tabindex", "0"); uploadLabel.addEventListener("keydown",e=>{ if(e.key==="Enter"||e.key===" ") document.getElementById("uploadPic").click(); }); }

      if (currentRole === "worker") document.getElementById("repairNavLink").style.display = "block";
      if (currentRole === "admin") { 
        const adminBtn = document.getElementById("adminApprovalBtnHeader"); if (adminBtn) adminBtn.style.display = "block"; 
        const adminNav = document.getElementById("adminNavLink"); if (adminNav) adminNav.style.display = "inline-flex"; 
      }

      // Initialize Firebase and load server data (best-effort)
      initFirebase();
      loadInitialData().then(() => {
        // seed admin history, generate ~90 days of machine history for exports and admin view
        try{ seedAdminHistory(); }catch(e){}
        try{ generateMachineHistory(90); }catch(e){}
        initMachines();
        initDashboard();
        populateRepairMachineSelect();
        populateScheduleMachineSelect();
      }).catch(()=>{ initMachines(); initDashboard(); populateRepairMachineSelect(); });

      // Storage event fallback: listen for alerts from other clients on same origin
      window.addEventListener('storage', (e) => {
        try {
          if (!e || !e.key) return;
          if (e.key === 'smartplant_alert' && e.newValue) {
            const data = JSON.parse(e.newValue);
            if (!window.alertsHistory) window.alertsHistory = [];
            if (!window.alertsHistory.find(a=>a.id===data.id)) {
              window.alertsHistory.push(data);
              try{ checkAndShowAlerts(); }catch(e){}
              if (currentRole === 'admin') {
                try{ showNotification(data.message || 'New alert'); }catch(e){}
                try{ showDesktopNotification('Alert', data.message || 'New alert'); }catch(e){}
                try{ incrementAdminBadge(); playAdminBeep(); }catch(e){}
                try{ const adminPage = document.getElementById('adminRequestsPage'); if (adminPage && adminPage.classList.contains('active')) renderAdminRequestsPage(); }catch(e){}
              }
            }
          }
        } catch(err) { console.warn('storage event handler error', err); }
      });

        // Login uses predefined credentials; registration UI removed
    });

    document.getElementById("closeProfileSettings").addEventListener("click", closeProfileSettings);
    document.getElementById("closeDetails").addEventListener("click", closeDetails);
    document.getElementById("scheduleBackBtn").addEventListener("click", ()=>navigateTo("dashboardPage"));
    profileSettingsForm.addEventListener("submit", saveSettings);
    detailsModal.addEventListener("click", (e) => { if (e.target === detailsModal) closeDetails(); });
    profileSettingsModal.addEventListener("click", (e) => { if (e.target === profileSettingsModal) closeProfileSettings(); });

    function exportReport() {
      try {
        // create CSV of machines + activity logs
        let csv = "Type,Field,Value\n";
        machinesData.forEach(m => {
          csv += `Machine,ID,${m.id}\n`;
          csv += `Machine,Name,${m.name}\n`;
          csv += `Machine,Status,${m.status}\n`;
          csv += `Machine,Power,${m.power}\n`;
          csv += `Machine,Temperature,${m.temperature}\n`;
        });
        csv += "\nActivity Logs\n";
        activityLogs.forEach(a => { csv += `Log,Entry,${a}\n`; });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `smartplant_report_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification('CSV report downloaded.');
      } catch (e) {
        console.error(e);
        showNotification('Export failed. See console for details.');
      }
    }

    // --- Admin Requests page rendering & exports ---
    function renderAdminRequestsPage() {
      const sparesNode = document.getElementById('adminSparesContainer');
      const assistNode = document.getElementById('adminAssistanceContainer');
      if (!sparesNode || !assistNode) return;
      sparesNode.innerHTML = '';
      assistNode.innerHTML = '';

      // Spare requests: Pending and History
      const pendingSpares = spareRequests.slice().filter(r => !r.status || r.status.toLowerCase().includes('pending') || r.status.toLowerCase().includes('submitted'));
      const historySpares = spareRequests.slice().filter(r => r.status && !(r.status.toLowerCase().includes('pending') || r.status.toLowerCase().includes('submitted')));
      const pendingHeader = document.createElement('h4'); pendingHeader.textContent = 'Spare Part Requests — Pending'; sparesNode.appendChild(pendingHeader);
      if (pendingSpares.length === 0) { const p = document.createElement('p'); p.style.textAlign='center'; p.style.color='#96ded1'; p.textContent='No pending spare part requests.'; sparesNode.appendChild(p); }
      else {
        pendingSpares.reverse().forEach(r => {
          const div = document.createElement('div'); div.className='request-item';
          div.innerHTML = `
            <p><strong>ID:</strong> #${r.id} | <strong>Status:</strong> <span class="status-pending">${r.status||'PENDING'}</span></p>
            <p><strong>Part:</strong> ${r.partName} (x${r.quantity})</p>
            <p><strong>Machine:</strong> ${r.machine}</p>
            <p><strong>Requester:</strong> ${r.requester} | <strong>Time:</strong> ${r.timestamp}</p>
            <p><strong>ETA:</strong> ${r.eta||'-'}</p>
          `;
          const actions = document.createElement('div'); actions.className='approval-actions';
          const approve = document.createElement('button'); approve.className='approve'; approve.textContent='Approve'; approve.onclick=()=>{ approveRequest(r.id); renderAdminRequestsPage(); };
          const reject = document.createElement('button'); reject.className='reject'; reject.textContent='Reject'; reject.onclick=()=>{ rejectRequest(r.id); renderAdminRequestsPage(); };
          actions.appendChild(approve); actions.appendChild(reject); div.appendChild(actions);
          sparesNode.appendChild(div);
        });
      }
      const histHeader = document.createElement('h4'); histHeader.style.marginTop='12px'; histHeader.textContent='Spare Part Requests — History (Resolved/Approved/Rejected)'; sparesNode.appendChild(histHeader);
      if (historySpares.length === 0) { const p2 = document.createElement('p'); p2.style.textAlign='center'; p2.style.color='#96ded1'; p2.textContent='No historical spare requests.'; sparesNode.appendChild(p2); }
      else {
        historySpares.reverse().forEach(r => {
          const div = document.createElement('div'); div.className='request-item';
          div.innerHTML = `
            <p><strong>ID:</strong> #${r.id} | <strong>Status:</strong> <span class="${(r.status||'').toLowerCase().includes('approved')?'status-approved':'status-rejected'}">${(r.status||'').toUpperCase()}</span></p>
            <p><strong>Part:</strong> ${r.partName} (x${r.quantity})</p>
            <p><strong>Machine:</strong> ${r.machine}</p>
            <p><strong>Requester:</strong> ${r.requester} | <strong>Time:</strong> ${r.timestamp}</p>
            <p><strong>ETA:</strong> ${r.eta||'-'}</p>
          `; sparesNode.appendChild(div);
        });
      }

      // Assistance requests: Pending and History
      const pendingAssist = assistanceRequests.slice().filter(r => !r.status || r.status.toLowerCase().includes('submitted') || r.status.toLowerCase().includes('pending'));
      const historyAssist = assistanceRequests.slice().filter(r => r.status && !(r.status.toLowerCase().includes('submitted') || r.status.toLowerCase().includes('pending')));
      const pendingAHeader = document.createElement('h4'); pendingAHeader.textContent='Assistance Requests — Pending'; assistNode.appendChild(pendingAHeader);
      if (pendingAssist.length === 0) { const p = document.createElement('p'); p.style.textAlign='center'; p.style.color='#96ded1'; p.textContent='No pending assistance requests.'; assistNode.appendChild(p); }
      else {
        pendingAssist.reverse().forEach(r => {
          const div = document.createElement('div'); div.className='request-item';
          div.innerHTML = `
            <p><strong>ID:</strong> #${r.id} | <strong>Status:</strong> <span class="status-pending">${r.status||'SUBMITTED'}</span></p>
            <p><strong>Machine:</strong> ${r.machine}</p>
            <p><strong>Requester:</strong> ${r.requester} | <strong>Time:</strong> ${r.timestamp}</p>
            <p><strong>Issue:</strong> ${r.issue}</p>
          `;
          const actions = document.createElement('div'); actions.className='approval-actions';
          const assign = document.createElement('button'); assign.className='approve'; assign.textContent='Assign'; assign.onclick=async()=>{ r.status='Assigned'; try{ if(window.db && r.id && typeof r.id==='string') await db.collection('assistanceRequests').doc(r.id).update({status:'Assigned'}); }catch(e){}; renderAdminRequestsPage(); };
          actions.appendChild(assign); div.appendChild(actions); assistNode.appendChild(div);
        });
      }
      const histAHeader = document.createElement('h4'); histAHeader.style.marginTop='12px'; histAHeader.textContent='Assistance Requests — History (Resolved/Assigned/Rejected)'; assistNode.appendChild(histAHeader);
      if (historyAssist.length === 0) { const p2 = document.createElement('p'); p2.style.textAlign='center'; p2.style.color='#96ded1'; p2.textContent='No historical assistance requests.'; assistNode.appendChild(p2); }
      else {
        historyAssist.reverse().forEach(r => {
          const div = document.createElement('div'); div.className='request-item';
          div.innerHTML = `
            <p><strong>ID:</strong> #${r.id} | <strong>Status:</strong> <span class="${(r.status||'').toLowerCase().includes('assigned')?'status-approved':'status-rejected'}">${(r.status||'').toUpperCase()}</span></p>
            <p><strong>Machine:</strong> ${r.machine}</p>
            <p><strong>Requester:</strong> ${r.requester} | <strong>Time:</strong> ${r.timestamp}</p>
            <p><strong>Issue:</strong> ${r.issue}</p>
          `; assistNode.appendChild(div);
        });
      }

      // Machine history
      const machinesNode = document.getElementById('adminMachinesContainer');
      if (machinesNode) {
        machinesNode.innerHTML = '';
        machinesData.forEach(m => {
          const d = document.createElement('div'); d.className='request-item';
          d.innerHTML = `
            <p><strong>ID:</strong> ${m.id} | <strong>Name:</strong> ${m.name} | <strong>Status:</strong> ${m.status}</p>
            <p><strong>Power:</strong> ${m.power} kW | <strong>Temp:</strong> ${m.temperature} °C</p>
          `;
          machinesNode.appendChild(d);
        });
      }

      // small summary and link to download historical data
      const histSummary = document.getElementById('adminMachinesHistorySummary');
      if (histSummary) {
        const days = machineHistory.length ? Math.max(1, new Set(machineHistory.map(h=>h.date)).size) : 0;
        histSummary.textContent = `Machine history generated: ${days} days (${machineHistory.length} records)`;
      }

      // Scheduled tasks
      const schedNode = document.getElementById('adminScheduledContainer');
      if (schedNode) {
        schedNode.innerHTML = '';
        scheduledTasks.forEach(t => {
          const d = document.createElement('div'); d.className='request-item';
          d.innerHTML = `<p><strong>ID:</strong> ${t.id} | <strong>Machine:</strong> ${t.machine} | <strong>Task:</strong> ${t.name} | <strong>Time:</strong> ${t.time}</p>`;
          schedNode.appendChild(d);
        });
      }

      // Activity logs
      const actNode = document.getElementById('adminActivityLogs');
      if (actNode) {
        actNode.innerHTML = '';
        activityLogs.slice().reverse().forEach(a => { const li=document.createElement('li'); li.textContent=a; actNode.appendChild(li); });
      }

      // Alerts history
      const alertsNode = document.getElementById('adminAlertsHistory');
      if (alertsNode) {
        alertsNode.innerHTML = '';
        const hist = (window.alertsHistory||[]).slice().reverse().slice(0,200);
        if(hist.length===0) alertsNode.innerHTML = '<p style="color:#96ded1;">No alerts recorded.</p>';
        hist.forEach(a=>{
          const d = document.createElement('div'); d.className='request-item';
          d.innerHTML = `<p><strong>${a.timestamp}</strong> — ${a.machine} — ${a.type} — ${a.message}</p>`;
          alertsNode.appendChild(d);
        });
      }

      // Spare parts inventory summary
      const invNode = document.getElementById('adminSpareInventory');
      if (invNode) {
        invNode.innerHTML = '';
        for(const [machine, parts] of Object.entries(sparePartsCatalog)){
          const d = document.createElement('div'); d.className='request-item';
          d.innerHTML = `<p><strong>${machine}</strong> — ${parts.length} parts available</p>`;
          const list = document.createElement('ul'); list.style.marginLeft='18px';
          parts.slice(0,10).forEach(p=>{ const li=document.createElement('li'); li.textContent=p.name; list.appendChild(li); });
          d.appendChild(list);
          invNode.appendChild(d);
        }
      }

      // Energy summary (aggregate monthly energy)
      const energyNode = document.getElementById('adminEnergySummary');
      if (energyNode) {
        energyNode.innerHTML = '';
        const monthly = {};
        machineHistory.forEach(h=>{
          const m = h.date.slice(0,7); // YYYY-MM
          monthly[m] = (monthly[m]||0) + (Number(h.energyKwh)||0);
        });
        const keys = Object.keys(monthly).sort().reverse().slice(0,6);
        if(keys.length===0) energyNode.innerHTML = '<p style="color:#96ded1;">No energy history available.</p>';
        keys.forEach(k=>{
          const d=document.createElement('div'); d.className='request-item'; d.innerHTML = `<p><strong>${k}</strong> — Total Energy: ${monthly[k].toFixed(2)} kWh</p>`; energyNode.appendChild(d);
        });
      }
    }

    // navigate hook to render admin page
    (function(){
      const oldNav = navigateTo;
      navigateTo = function(pageId){
        oldNav(pageId);
        if (pageId === 'adminRequestsPage') renderAdminRequestsPage();
      };
    })();

    function exportAdminRequestsCSV(){
      let csv = 'Type,ID,Machine,Part/Issue,Quantity,Requester,Time,Status,ETA\n';
      spareRequests.forEach(r=>{ csv += `Spare,${r.id||''},${r.machine||''},${r.partName||''},${r.quantity||''},${r.requester||''},${r.timestamp||''},${r.status||''},${r.eta||''}\n`; });
      assistanceRequests.forEach(r=>{ csv += `Assist,${r.id||''},${r.machine||''},${r.issue||''},,${r.requester||''},${r.timestamp||''},${r.status||''},\n`; });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `admin_requests_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification('CSV downloaded');
    }

    // Export all admin data (requests + machines + scheduled + activity) as CSV
    function exportAdminAllCSV(){
      try{
        let csv = 'Section,Type,ID,Machine,Item,Quantity,Requester,Time,Status,ETA\n';
        spareRequests.forEach(r=>{ csv += `Requests,Spare,${r.id||''},${r.machine||''},${r.partName||''},${r.quantity||''},${r.requester||''},${r.timestamp||''},${r.status||''},${r.eta||''}\n`; });
        assistanceRequests.forEach(r=>{ csv += `Requests,Assist,${r.id||''},${r.machine||''},${r.issue||''},,${r.requester||''},${r.timestamp||''},${r.status||''},\n`; });
        csv += '\nMachines\n';
        machinesData.forEach(m=>{ csv += `Machines,,${m.id||''},${m.name||''},, , , ,Status:${m.status||''},\n`; });
        csv += '\nScheduledTasks\n';
        scheduledTasks.forEach(s=>{ csv += `Scheduled,,${s.id||''},${s.machine||''},${s.name||''},, ,${s.time||''},,\n`; });
        csv += '\nActivityLogs\n';
        activityLogs.forEach(a=>{ csv += `Activity,,, , , , ,${a.replace(/\n/g,' ')}\n`; });
        // append machine history (daily summaries)
        csv += '\nMachineHistory\n';
        csv += 'Machine,Date,AvgPower,AvgTemp,EnergyKwh\n';
        machineHistory.forEach(h=>{ csv += `${h.machineName||''},${h.date||''},${h.avgPower||''},${h.avgTemp||''},${h.energyKwh||''}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download = `smartplant_all_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification('All data CSV downloaded');
      }catch(e){ console.error(e); showNotification('Export failed'); }
    }

    function exportAdminRequestsXLSX(){
      try{
        const rows = [['Type','ID','Machine','Part/Issue','Quantity','Requester','Time','Status','ETA']];
        spareRequests.forEach(r=> rows.push(['Spare', r.id||'', r.machine||'', r.partName||'', r.quantity||'', r.requester||'', r.timestamp||'', r.status||'', r.eta||'']));
        assistanceRequests.forEach(r=> rows.push(['Assist', r.id||'', r.machine||'', r.issue||'', '', r.requester||'', r.timestamp||'', r.status||'', '']));
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Requests');
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type:'application/octet-stream'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`admin_requests_${Date.now()}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification('XLSX downloaded');
      }catch(e){ console.error(e); showNotification('XLSX export failed'); }
    }

    // Export all admin data as XLSX (multiple sheets)
    function exportAdminAllXLSX(){
      try{
        const reqRows = [['Type','ID','Machine','Item/Issue','Quantity','Requester','Time','Status','ETA']];
        spareRequests.forEach(r=> reqRows.push(['Spare', r.id||'', r.machine||'', r.partName||'', r.quantity||'', r.requester||'', r.timestamp||'', r.status||'', r.eta||'']));
        assistanceRequests.forEach(r=> reqRows.push(['Assist', r.id||'', r.machine||'', r.issue||'', '', r.requester||'', r.timestamp||'', r.status||'', '']));

        const machRows = [['ID','Name','Status','Power','Temperature']];
        machinesData.forEach(m=> machRows.push([m.id||'', m.name||'', m.status||'', m.power||'', m.temperature||'']));

        const schedRows = [['ID','Machine','Task','Time']];
        scheduledTasks.forEach(s=> schedRows.push([s.id||'', s.machine||'', s.name||'', s.time||'']));

        const actRows = [['Log']]; activityLogs.forEach(a=> actRows.push([a]));
        // machine history sheet
        const histRows = [['Machine','Date','AvgPower','AvgTemp','EnergyKwh']];
        machineHistory.forEach(h=> histRows.push([h.machineName||'', h.date||'', h.avgPower||'', h.avgTemp||'', h.energyKwh||'']));
        // also include alerts and spare inventory in CSV
        csv += '\nAlertsHistory\n';
        csv += 'Timestamp,Machine,Type,Message,Value\n';
        (window.alertsHistory||[]).forEach(a=> csv += `${a.timestamp||''},${a.machine||''},${a.type||''},"${(a.message||'').replace(/"/g,'""')}",${a.value||''}\n`);
        csv += '\nSpareInventory\n';
        csv += 'Machine,PartID,PartName\n';
        for(const [machine, parts] of Object.entries(sparePartsCatalog)){
          parts.forEach(p=> csv += `${machine},${p.id||''},"${(p.name||'').replace(/"/g,'""')}"\n`);
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(reqRows), 'Requests');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(machRows), 'Machines');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(schedRows), 'Scheduled');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(actRows), 'ActivityLogs');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(histRows), 'MachineHistory');
        // Alerts sheet
        const alertsRows = [['Timestamp','Machine','Type','Message','Value']];
        (window.alertsHistory||[]).forEach(a=> alertsRows.push([a.timestamp||'', a.machine||'', a.type||'', a.message||'', a.value||'']));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(alertsRows), 'AlertsHistory');
        // Spare inventory sheet
        const invRows = [['Machine','PartID','PartName']];
        for(const [machine, parts] of Object.entries(sparePartsCatalog)){
          parts.forEach(p=> invRows.push([machine, p.id||'', p.name||'']));
        }
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(invRows), 'SpareInventory');
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type:'application/octet-stream'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`smartplant_all_${Date.now()}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification('All data XLSX downloaded');
      }catch(e){ console.error(e); showNotification('XLSX export failed'); }
    }

    async function exportAdminRequestsPDF(){
      try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 12; doc.setFontSize(12); doc.text('Admin Requests', 12, y); y+=8;
        doc.setFontSize(10);
        const writeLine = (text)=>{ doc.text(text, 12, y); y+=6; if(y>270){ doc.addPage(); y=12; } };
        writeLine('--- Spare Requests ---');
        spareRequests.forEach(r=> writeLine(`#${r.id} | ${r.machine} | ${r.partName} x${r.quantity} | ${r.requester} | ${r.status}`));
        y+=4; writeLine('--- Assistance Requests ---');
        assistanceRequests.forEach(r=> writeLine(`#${r.id} | ${r.machine} | ${r.issue} | ${r.requester} | ${r.status}`));
        doc.save(`admin_requests_${Date.now()}.pdf`);
        showNotification('PDF downloaded');
      }catch(e){ console.error(e); showNotification('PDF export failed'); }
    }

    // Export all admin data as PDF
    async function exportAdminAllPDF(){
      try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(); let y=12; doc.setFontSize(14); doc.text('SmartPlant - Full Admin Export', 12, y); y+=8; doc.setFontSize(10);
        const write = (t)=>{ doc.text(t, 12, y); y+=6; if(y>270){ doc.addPage(); y=12; } };
        write('--- Spare Requests ---');
        spareRequests.forEach(r=> write(`#${r.id} | ${r.machine} | ${r.partName} x${r.quantity} | ${r.requester} | ${r.status} | ${r.timestamp}`));
        y+=4; write('--- Assistance Requests ---');
        assistanceRequests.forEach(r=> write(`#${r.id} | ${r.machine} | ${r.issue} | ${r.requester} | ${r.status} | ${r.timestamp}`));
        y+=4; write('--- Machines ---');
        machinesData.forEach(m=> write(`ID:${m.id} | ${m.name} | Status:${m.status} | Power:${m.power}kW | Temp:${m.temperature}°C`));
        y+=4; write('--- Scheduled Tasks ---');
        scheduledTasks.forEach(s=> write(`ID:${s.id} | ${s.machine} | ${s.name} | ${s.time}`));
        y+=4; write('--- Activity Logs ---');
        activityLogs.forEach(a=> write(a));
        y+=4; write('--- Machine History (last days) ---');
        machineHistory.forEach(h=> write(`${h.date} | ${h.machineName} | Power:${h.avgPower}kW | Temp:${h.avgTemp}°C | Energy:${h.energyKwh}kWh`));
        doc.save(`smartplant_all_${Date.now()}.pdf`);
        showNotification('All data PDF downloaded');
      }catch(e){ console.error(e); showNotification('PDF export failed'); }
    }

    // =======================================================================
    // REPAIR PAGE LOGIC
    // =======================================================================
    let requestIdCounter = 1;
    let spareRequests = []; // { id, machine, partName, fileName, quantity, requester, timestamp, eta, status }
    let assistanceRequests = []; // { id, machine, issue, requester, timestamp, status }
    // Seed some previous resolved requests for admin history (only in-memory when Firestore empty)
    function seedAdminHistory() {
      if (!spareRequests || spareRequests.length === 0) {
        spareRequests.push({ id: 'hist-sp-1', machine: 'Primary Extruder', partName: 'Heating Element', fileName: 'heating_element.jpg', quantity: 2, requester: 'worker1', timestamp: new Date(Date.now()-86400000*10).toLocaleString(), eta: '15 min', status: 'Resolved' });
        spareRequests.push({ id: 'hist-sp-2', machine: 'Chemical Mixer', partName: 'Agitator Blade Set', fileName: 'agitator_blade.jpg', quantity: 1, requester: 'worker2', timestamp: new Date(Date.now()-86400000*5).toLocaleString(), eta: '45 min', status: 'Approved' });
        spareRequests.push({ id: 'hist-sp-3', machine: 'Milling Machine Alpha', partName: 'Spindle Bearing', fileName: 'spindle_bearing.jpg', quantity: 1, requester: 'jane.d', timestamp: new Date(Date.now()-86400000*20).toLocaleString(), eta: '1 hour', status: 'Resolved' });
        spareRequests.push({ id: 'hist-sp-4', machine: 'Injection Molder 3000', partName: 'Barrel Heater Bands', fileName: 'heater_bands.jpg', quantity: 3, requester: 'operator7', timestamp: new Date(Date.now()-86400000*14).toLocaleString(), eta: '2 hours', status: 'Resolved' });
        spareRequests.push({ id: 'hist-sp-5', machine: 'Conveyor Belt Sys C5', partName: 'Chip Conveyor Belt', fileName: 'chip_belt.jpg', quantity: 1, requester: 'sam.w', timestamp: new Date(Date.now()-86400000*2).toLocaleString(), eta: '30 min', status: 'Approved' });
      }
      if (!assistanceRequests || assistanceRequests.length === 0) {
        assistanceRequests.push({ id: 'hist-as-1', machine: 'Welding Station WS2', issue: 'Broken clamp', requester: 'worker3', timestamp: new Date(Date.now()-86400000*7).toLocaleString(), status: 'Resolved' });
        assistanceRequests.push({ id: 'hist-as-2', machine: 'Assembly Robot R1', issue: 'Calibration drift', requester: 'worker4', timestamp: new Date(Date.now()-86400000*3).toLocaleString(), status: 'Assigned' });
        assistanceRequests.push({ id: 'hist-as-3', machine: 'Pressing Machine', issue: 'Hydraulic leak', requester: 'alex.k', timestamp: new Date(Date.now()-86400000*12).toLocaleString(), status: 'Resolved' });
        assistanceRequests.push({ id: 'hist-as-4', machine: 'Primary Extruder', issue: 'Temperature sensor fault', requester: 'linda.r', timestamp: new Date(Date.now()-86400000*4).toLocaleString(), status: 'Resolved' });
      }
    }

    const sparePartsCatalog = {
      "Primary Extruder": [
        { id: 'pe1', name: "Heating Element", file: "heating_element.jpg" },
        { id: 'pe2', name: "Extrusion Screw", file: "extrusion_screw.jpg" },
        { id: 'pe3', name: "Gearbox Oil Seal", file: "oil_seal.jpg" },
        { id: 'pe4', name: "Motor Coupling", file: "motor_coupling.jpg" },
        { id: 'pe5', name: "Hopper Feed Mechanism", file: "hopper_feed.jpg" },
        { id: 'pe6', name: "Barrel Heater Bands", file: "heater_bands.jpg" },
        { id: 'pe7', name: "Pressure Transducer", file: "pressure_sensor.jpg" },
        { id: 'pe8', name: "Die Head Fasteners", file: "die_fasteners.jpg" },
      ],
      "Milling Machine Alpha": [
        { id: 'mma1', name: "Spindle Bearing", file: "spindle_bearing.jpg" },
        { id: 'mma2', name: "Tool Changer Claw", file: "tool_claw.jpg" },
        { id: 'mma3', name: "Z-Axis Linear Guide", file: "linear_guide.jpg" },
        { id: 'mma4', name: "Coolant Pump Filter", file: "coolant_filter.jpg" },
        { id: 'mma5', name: "Servo Motor Encoder", file: "servo_encoder.jpg" },
        { id: 'mma6', name: "Chip Conveyor Belt", file: "chip_belt.jpg" },
      ],
      "Chemical Mixer": [
        { id: 'cm1', name: "Agitator Blade Set", file: "agitator_blade.jpg" },
        { id: 'cm2', name: "Inlet Valve Gasket", file: "inlet_gasket.jpg" },
        { id: 'cm3', name: "Main Motor Pulley", file: "motor_pulley.jpg" },
        { id: 'cm4', name: "Temperature Probe", file: "temp_probe.jpg" },
        { id: 'cm5', name: "Discharge Pump Impeller", file: "pump_impeller.jpg" },
      ],
      "Pressing Machine": [
        { id: 'pm1', name: "Hydraulic Cylinder Seal", file: "cylinder_seal.jpg" },
        { id: 'pm2', name: "Safety Sensor Array", file: "safety_sensor.jpg" },
        { id: 'pm3', name: "Piston Rod Wiper", file: "rod_wiper.jpg" },
        { id: 'pm4', name: "Pressure Relief Valve", file: "relief_valve.jpg" },
        { id: 'pm5', name: "Die Clamping Bolt Set", file: "clamping_bolts.jpg" },
      ],
      "Assembly Robot R1": [
        { id: 'ar1', name: "End-Effector Gripper", file: "gripper.jpg" },
        { id: 'ar2', name: "Joint Actuator Motor", file: "actuator_motor.jpg" },
        { id: 'ar3', name: "Flex Cable Harness", file: "flex_cable.jpg" },
        { id: 'ar4', name: "Vision Camera Lens", file: "camera_lens.jpg" },
        { id: 'ar5', name: "Force Sensor Pad", file: "force_sensor.jpg" },
      ],
      "Injection Molder 3000": [
        { id: 'im1', name: "Nozzle Tip", file: "nozzle_tip.jpg" },
        { id: 'im2', name: "Mold Clamp Solenoid", file: "clamp_solenoid.jpg" },
        { id: 'im3', name: "Tie Bar Bushings", file: "tie_bar_bushings.jpg" },
        { id: 'im4', name: "Screw Barrel Liner", file: "barrel_liner.jpg" },
      ],
      "Welding Station WS2": [
        { id: 'ws1', name: "Welding Torch Tip Pack", file: "torch_tip.jpg" },
        { id: 'ws2', name: "Wire Feeder Roller", file: "feeder_roller.jpg" },
        { id: 'ws3', name: "Gas Nozzle Set", file: "gas_nozzle.jpg" },
        { id: 'ws4', name: "Contact Tip Holder", file: "tip_holder.jpg" },
      ],
      "Conveyor Belt Sys C5": [
        { id: 'cs1', name: "Drive Roller Assembly", file: "drive_roller.jpg" },
        { id: 'cs2', name: "Belt Splicing Kit", file: "splicing_kit.jpg" },
        { id: 'cs3', name: "Idler Bearing Unit", file: "idler_bearing.jpg" },
        { id: 'cs4', name: "Belt Scraper Blade", file: "scraper_blade.jpg" },
        { id: 'cs5', name: "Tension Adjust Screw", file: "tension_screw.jpg" },
      ]
    };

    function populateRepairMachineSelect() {
      const select = document.getElementById('machineSelect');
      const assistanceSelect = document.getElementById('assistanceMachineSelect');
      const machineNames = machinesData.map(m => m.name).sort();
      select.innerHTML = '<option value="">-- Select a Machine --</option>';
      assistanceSelect.innerHTML = '<option value="">-- Select a Machine --</option>';
      machineNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
        const assOption = option.cloneNode(true);
        assistanceSelect.appendChild(assOption);
      });
      if (select.options.length > 1) { select.value = select.options[1].value; populateSpareParts(); }
      else document.getElementById('sparesGrid').innerHTML = '<p id="partsPlaceholder" style="text-align:center; color:#96ded1;">Select a machine to view available spare parts.</p>';
    }

    function populateSpareParts() {
      const machineName = document.getElementById('machineSelect').value;
      const sparesGrid = document.getElementById('sparesGrid');
      sparesGrid.innerHTML = '';
      if (!machineName) { sparesGrid.innerHTML = '<p id="partsPlaceholder" style="text-align:center; color:#96ded1;">Select a machine to view available spare parts.</p>'; return; }
      const parts = sparePartsCatalog[machineName] || [];
      if (parts.length === 0) { sparesGrid.innerHTML = `<p style="text-align:center; color:#ff9800;">No spare parts cataloged for ${machineName}.</p>`; return; }
      parts.forEach(part => {
        const card = document.createElement('div');
        card.className = 'spare-card';
        card.setAttribute('data-part-id', part.id);
        card.innerHTML = `
          <img src="images/${part.file}" alt="${part.name} preview" onerror="this.onerror=null;this.src='images/default_part.png';" />
          <h4>${part.name}</h4>
          <p>File: ${part.file}</p>
          <div class="spare-actions">
            <input type="number" id="qty-${part.id}" value="1" min="1" max="10" aria-label="Quantity of ${part.name}">
            <button class="request-btn" onclick="requestPart('${machineName}', '${part.name}', '${part.file}', 'qty-${part.id}')">Request</button>
          </div>
        `;
        sparesGrid.appendChild(card);
      });
    }

    function calculateETA(qty) {
      if (qty <= 2) return "15 min";
      if (qty <= 5) return "45 min";
      const hours = Math.ceil(qty / 4);
      return `${hours} hour${hours > 1 ? 's' : ''}`;
    }

    async function requestPart(machineName, partName, fileName, qtyInputId) {
      const qtyInput = document.getElementById(qtyInputId);
      const quantity = parseInt(qtyInput.value);
      if (isNaN(quantity) || quantity <= 0) { showNotification("Please enter a valid quantity."); return; }
      if (currentRole !== 'worker') { showNotification("Access Denied: Only Workers can request spare parts."); return; }
      const eta = calculateETA(quantity);
      const newRequest = {
        _localId: requestIdCounter++,
        id: requestIdCounter,
        machine: machineName,
        partName: partName,
        fileName: fileName,
        quantity: quantity,
        requester: currentUsername,
        timestamp: new Date().toLocaleString(),
        eta: eta,
        status: 'Pending'
      };
      spareRequests.push(newRequest);
      activityLogs.push(`Spare part request submitted: ${quantity} x ${partName} for ${machineName}.`);
      showLoader();
      setTimeout(async () => {
        hideLoader();
        showNotification(`Request sent! Spare Part: ${partName} (x${quantity}) submitted for approval. Estimated ETA: ${eta}`);
        if (window.firebaseInitialized) {
          const docId = await saveSpareRequestToFirebase(newRequest);
          if (docId) newRequest.id = docId;
        }
        // create an alert so it shows in Alerts and admin is notified
        try{ createAlert('SpareRequest', `Spare request: ${partName} for ${machineName} by ${currentUsername}`, { machine: machineName, part: partName, requester: currentUsername }); }catch(e){}
        // Simulated technician auto-approval after 10s
        setTimeout(async () => {
          newRequest.status = 'Approved';
          showNotification(`[Technician Auto-Response] Spare part request ${newRequest.id} (${partName}) has been approved. ETA: ${newRequest.eta}`);
          try {
            if (window.db && newRequest.id && typeof newRequest.id === 'string') {
              await db.collection('spareRequests').doc(newRequest.id).update({ status: 'Approved' });
            }
          } catch (e) {}
          if (document.getElementById('adminApprovalModal').getAttribute('aria-hidden') === 'false') refreshApprovalList();
        }, 10000);
      }, 800);
    }

    // Assistance
    function openAssistanceModal() {
      if (currentRole !== 'worker') { showNotification("Access Denied: Only Workers can request assistance."); return; }
      document.getElementById('assistanceModal').setAttribute('aria-hidden', 'false');
      document.getElementById('assistanceModal').style.display = 'flex';
      document.getElementById('assistanceModal').focus();
    }
    function closeAssistanceModal() {
      document.getElementById('assistanceModal').setAttribute('aria-hidden', 'true');
      document.getElementById('assistanceModal').style.display = 'none';
      document.getElementById('assistanceMachineSelect').value = '';
      document.getElementById('issueNote').value = '';
    }
    document.getElementById('assistanceModalForm').addEventListener('submit', sendAssistanceRequest);

    async function sendAssistanceRequest(e) {
      e.preventDefault();
      const machine = document.getElementById('assistanceMachineSelect').value;
      const issue = document.getElementById('issueNote').value.trim();
      if (!machine || !issue) { showNotification("Please select a machine and describe the issue."); return; }
      const newRequest = { _localId: requestIdCounter++, id: requestIdCounter, machine: machine, issue: issue, requester: currentUsername, timestamp: new Date().toLocaleString(), status: 'Submitted' };
      assistanceRequests.push(newRequest);
      activityLogs.push(`Assistance request submitted for ${machine}.`);
      showLoader();
      setTimeout(async () => {
        hideLoader();
        showNotification("Assistance Request Sent! Technicians have been notified.");
        closeAssistanceModal();
        if (window.firebaseInitialized) {
          const docId = await saveAssistanceToFirebase(newRequest);
          if (docId) newRequest.id = docId;
        }
        // create an alert for admin + alerts page for this assistance request
        try{ createAlert('AssistanceRequest', `Assistance request for ${machine} by ${currentUsername}: ${issue}`, { machine, issue, requester: currentUsername }); }catch(e){}
        setTimeout(async () => {
          showNotification(`[Technician Response] Ticket ${newRequest.id} for ${machine} is assigned and a technician is on the way.`);
          newRequest.status = 'Assigned';
          try {
            if (window.db && newRequest.id && typeof newRequest.id === 'string') {
              await db.collection('assistanceRequests').doc(newRequest.id).update({ status: 'Assigned' });
            }
          } catch (e) {}
        }, 10000);
      }, 800);
    }

    // Admin approvals
    function openAdminApprovalModal() {
      if (currentRole !== 'admin') { showNotification("Access Denied: Only Admins can view pending requests."); return; }
      refreshApprovalList();
      document.getElementById('adminApprovalModal').setAttribute('aria-hidden', 'false');
      document.getElementById('adminApprovalModal').style.display = 'flex';
      document.getElementById('adminApprovalModal').focus();
    }
    function closeAdminApprovalModal() {
      document.getElementById('adminApprovalModal').setAttribute('aria-hidden', 'true');
      document.getElementById('adminApprovalModal').style.display = 'none';
    }

    function refreshApprovalList() {
      const container = document.getElementById('approvalListContainer');
      container.innerHTML = '';

      // Spare parts - all requests
      const spareHeader = document.createElement('h4'); spareHeader.textContent = 'Spare Part Requests (All)'; container.appendChild(spareHeader);
      if (spareRequests.length === 0) {
        const p = document.createElement('p'); p.style.textAlign = 'center'; p.style.color = '#96ded1'; p.textContent = 'No spare part requests.'; container.appendChild(p);
      } else {
        // sort by timestamp (best-effort)
        const sorted = spareRequests.slice().sort((a,b)=> (a.timestamp || '').toString().localeCompare((b.timestamp||'').toString())).reverse();
        sorted.forEach(req => {
          const item = document.createElement('div');
          item.className = 'request-item';
          const statusClass = req.status && req.status.toLowerCase().includes('approved') ? 'status-approved' : (req.status && req.status.toLowerCase().includes('reject') ? 'status-rejected' : 'status-pending');
          item.innerHTML = `
            <p><strong>ID:</strong> #${req.id} | <strong>Status:</strong> <span class="${statusClass}">${(req.status||'').toUpperCase()}</span></p>
            <p><strong>Part:</strong> ${req.partName} (x${req.quantity})</p>
            <p><strong>Machine:</strong> ${req.machine}</p>
            <p><strong>Requester:</strong> ${req.requester} | <strong>Time:</strong> ${req.timestamp}</p>
            <p><strong>ETA:</strong> ${req.eta||'-'}</p>
          `;
          const actions = document.createElement('div'); actions.className = 'approval-actions';
          if (!req.status || req.status.toLowerCase().includes('pending')) {
            const approveBtn = document.createElement('button'); approveBtn.className = 'approve'; approveBtn.textContent = 'Approve'; approveBtn.addEventListener('click', ()=>approveRequest(req.id));
            const rejectBtn = document.createElement('button'); rejectBtn.className = 'reject'; rejectBtn.textContent = 'Reject'; rejectBtn.addEventListener('click', ()=>rejectRequest(req.id));
            actions.appendChild(approveBtn); actions.appendChild(rejectBtn);
            item.appendChild(actions);
          }
          container.appendChild(item);
        });
      }

      // Assistance requests - all
      const assistHeader = document.createElement('h4'); assistHeader.textContent = 'Assistance Requests (All)'; assistHeader.style.marginTop = '18px'; container.appendChild(assistHeader);
      if (assistanceRequests.length === 0) {
        const p2 = document.createElement('p'); p2.style.textAlign = 'center'; p2.style.color = '#96ded1'; p2.textContent = 'No assistance requests.'; container.appendChild(p2);
      } else {
        const sortedA = assistanceRequests.slice().sort((a,b)=> (a.timestamp||'').toString().localeCompare((b.timestamp||'').toString())).reverse();
        sortedA.forEach(req => {
          const item = document.createElement('div'); item.className = 'request-item';
          const statusClass = req.status && req.status.toLowerCase().includes('assigned') ? 'status-approved' : (req.status && req.status.toLowerCase().includes('rejected') ? 'status-rejected' : 'status-pending');
          item.innerHTML = `
            <p><strong>ID:</strong> #${req.id} | <strong>Status:</strong> <span class="${statusClass}">${(req.status||'').toUpperCase()}</span></p>
            <p><strong>Machine:</strong> ${req.machine}</p>
            <p><strong>Requester:</strong> ${req.requester} | <strong>Time:</strong> ${req.timestamp}</p>
            <p><strong>Issue:</strong> ${req.issue}</p>
          `;
          container.appendChild(item);
        });
      }
    }

    async function approveRequest(id) {
      const request = spareRequests.find(req => req.id === id || req.id === Number(id));
      if (request) {
        request.status = 'Approved (Admin)';
        showNotification(`Spare Part Request #${id} approved by Admin.`);
        activityLogs.push(`Admin approved spare part request #${id}.`);
        try { if (window.db && typeof id === 'string') await db.collection('spareRequests').doc(id).update({ status: 'Approved (Admin)' }); } catch (e){}
        refreshApprovalList();
      }
    }

    async function rejectRequest(id) {
      const request = spareRequests.find(req => req.id === id || req.id === Number(id));
      if (request) {
        request.status = 'Rejected (Admin)';
        showNotification(`Spare Part Request #${id} rejected by Admin.`);
        activityLogs.push(`Admin rejected spare part request #${id}.`);
        try { if (window.db && typeof id === 'string') await db.collection('spareRequests').doc(id).update({ status: 'Rejected (Admin)' }); } catch (e){}
        refreshApprovalList();
      }
    }
  </script>
</body>
</html>